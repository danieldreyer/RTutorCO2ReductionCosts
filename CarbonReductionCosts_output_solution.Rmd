
---
title: Problem Set CarbonReductionCosts
output: 
  html_document: 
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE, echo=FALSE}
# Load libraries and source extra code
library(dplyr)
library(ggplot2)
library(gridExtra)
library(htmlTable)
library(stargazer)
library(pracma)
library(haven)
library(tidyverse)
library(ggalt)
library(RTutor)


# Options for rendering data frames
# If you knit to a Word docx file, try
# 
# data.frame.theme="word" 
# 
# (needs RStudio > 1.2.1)
# 
# You can also set the options like
# table.max.cols as chunk options
# Makes sense if there are too many, too wide
# columns in some chunks

RTutor::set.knit.print.opts(data.frame.theme="code", table.max.rows=25, table.max.cols=NULL, round.digits=5, signif.digits=8)


# continue knitting even if there is an error
knitr::opts_chunk$set(error = TRUE) 
```

# Problem Set: Estimating CO2 Reduction Costs

Author: Daniel Dreyer



Welcome to this interactive problem set. The awareness of climate change rose significantly over the past years. Purely questioning the moral of the population though, won't avoid its' highly uncertain effects. Therefore high efforts are made to find technical improvements as well as economical incentitives to avoid long term effects of climate change.   
In this problem set we will approach one possible countermeasure by analysing how carbon pricing would reduce emissions in the electricty sector. The analysis is based on **"Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach using the Shale Revolution"** by Joseph A. Cullen, Erin T. Mansur (2016) - further simply referred as Cullen. The paper and further ressources can be downloaded from <a href="https://www.aeaweb.org/articles?id=10.1257/pol.20150388   target = "_blank"> https://www.aeaweb.org/articles?id=10.1257/pol.20150388</a>

You will use the `Statstical Programming Language R` to replicate the analysis. Basic knowledge of `R` is required, but information on important function will be provided. 
Since each new exercise inherits the results of previous exercises, it is recommendated to solve them in order. However you are free to skip to any exercise you like if you feel so.  
If you are a complete novice in `R` you should not feel left behind. Understanding the basic concepts is straight forward, you can find useful information [here](https://cran.r-project.org/manuals.html).



### Contents

$\qquad$  Overview
  
$\qquad$  1 TBA

$\qquad$  2 TBA

$\qquad$ $\qquad$ 2.1 

$\qquad$  3 TBA

$\qquad$  4 TBA

$\qquad$  5 Conclusion

$\qquad$ References


## Exercise Content

$\qquad$ *Exercise 1* - Motivation (rename later)

$\qquad$ *Exercise 2* - TBA

$\qquad$ *Exercise 3* - TBA

$\qquad$ *Exercise 4* - TBA

$\qquad$ *Exercise 5* - TBA


### ReadME


The problem set offers different ways to interact with it. Coding exercises are marked as **TASK**. Some only need to be run, for others you need to complement a small part of the code, which is noted in the task description. Below you can read about the different types of interactions with their corresponding functions:   


 - Code Chunks: Require you to complete small parts of Code. The work flow of solving code chunks is intuitive and as follows:
                
  + `edit` : Click to insert your own Code into the chunk.
  + `run chunk`: Runs the chunk and displays outputs or errors in the corresponding console.
  + `check`: Check your input for against the solution.
  + `hint` : Should you have problem to solve a task, you can request a hint.  
&nbsp;

  
  Additional functions:    
                   
  + `data`: Redirects you to the data browser - you can view the loaded data with the help of an interface.
  + `solution` : Shows the solution of the task.  
&nbsp;

  
 - Quizzes: Evaluate your knownledge of topics before we dive in our analysis.
    
 - Info Boxes: Contain additional information on technical terms or documentation of functions.
 

After you finish a chapter, click `Go to next exercise` on the bottom or navigate around with the help of the bar on top.


## Exercise 1 -- Motivation

`Coal` is the **world's biggest source of energy and carbon emissions**, mostly because it is easy to store, transport, doesn't alter and can be mined in huge quantities around the world. This makes it desirable and cheap to use as a energy source. Given that the coal supply will last for decades, it is a major goal to find incentitives to reduce emissions from coal consumption.  
One alternative to coal is `natural gas`. Even though still being a fossil fuel, its' emissions and heat density are way superior to coal. Nevertheless, natural gas wasn't considered to be an real alternative to coal because to its higher prices more difficult handling up until the early 2000s.  
This changed due to the `Shale Revolution`, whereby natural gas was not only a by-product of the oil industry, but could now be extracted in a targeted manner and in large quantities. Lanfrancois (2012) estimates, that based on the Clean Power Plan introduced by the Obama administration in 2015, carbon dioxide emissions from the electricity industry could be reduced by 23 to 42 percent by switching existing coal powered generators to gas powered ones.  
  

***

### Info: Shale-Revolution
Shale gas is a form of natural gas and is extracted from shale formation, known as fracking. Since the start of the century, shale gas became a increasingly more important source of natural gas in the United States. Whereas in 2000 shale gas only provided 1% of the natural gas, nowadays in 2020 it makes up roughly 50%.
However at the same time, the environmental concerns of fracking are heavily debated.  

You can find further information on the topic here:  
<a href="https://en.wikipedia.org/wiki/Shale_ga   target = "_blank"> https://en.wikipedia.org/wiki/Shale_gas</a>s  
<a href="https://en.wikipedia.org/wiki/Hydraulic_fracturing   target = "_blank"> https://en.wikipedia.org/wiki/Hydraulic_fracturing</a>

***

  
With this in mind, in `Exercise 1` you will explore data to get insights in the current situation of the U.S. energy sector. You will look at the distribution of energy sources in the American market, its prices and the generated load over time.  

**Task:**
Use the `read_csv` command to *load the data set* and store it in a variable called `PaGP`.
The basic structure of the command is already given in the code chunk as a comment.


***

### Info: read.csv() and write.csv()
The command `read_csv()` reads in a **csv file** and stores it into a given name. Csv is a format for data, that uses commas as seperators and periods as decimals. Another version of are **csv2 files**, where semicolons are used for seperators and commas for decimals. We only use csv files here.

Given the file you want to read it is in the same working directory, you can use the command below:

```{r "1",eval=FALSE}
example <- read_csv("example.csv")
```

If the file is saved outside of your working directory there are two possibilities. For one you can insert the whole file path, if the file is you can navigate through the whole file path if your file is above 

If the file is saved in an structure above your working directory you have to additionally insert the full file path:

```{r "1__2",eval=FALSE}
example <- read_csv("C:/Data/example.csv")
```

For files that are located below the working directory it is sufficient to specify the following file path:

```{r "1__3",eval=FALSE}
example <- read_csv("./Data/example.csv")
```


Csv files can be saved using the `write.csv` command.

```{r "1__4",eval=FALSE}
write_csv(example, file="example.csv")
```

For further information, use `help(write.csv)`.

***


```{r "1__5"}
# ... <- read_csv("./Data/PaGP.csv")
PaGP <- read_csv("./Data/PaGP.csv")
```


**Task:** Lets take a look at the data we just imported. Use the `head()` command to show the first **eight** rows of the data set. 


```{r "1__6"}
# head(PaGP, ...)
head(PaGP, 8)

```


Alternatively you can press the `data` button to get redirected to the `Data Explorer` Tab. 

The date column is currently stored as a character. To be able visualize the date variable as a continuous variable, we have to convert is. Therefore, R has a build in date class.  
**Task:** Just press *check*.

```{r "1__7"}
PaGP <- as.data.frame(PaGP)
PaGP$date <- as.Date(PaGP$date)
```

  
The data frame contains monthly numbers of generated MwH with coal and gas as well as prices of Energy commodities. 
Keep in mind that different commodities are traded in different units. Oil is traded in barrels (\$/bbl), coal in metric tons (\$/mt) and gas in British thermal units($/mmbtu). The natural gas index is set to 100 in the year 2010 and changes accordingly.
Prior to visualizing the data and to get clearer results, lets modifiy the data set. As mentioned before, commodities are traded in different units. Therefore we will add new entries for normalized prices, which gives us a good cost basis to produce the same amount of energy with each commodity.  On this account, we assume that `1 MwH = 0.454 mT Coal = 3.412 mmBtu Natural Gas`.

**Task:** Perform the above calculations. Just press *check*.
  

***

### Info: Pipe, mutate, select
The pipe operator `%>%` is a feature provided by the `dplyr` Package. Essentially it allows to exectute multiple operation on a dataframe at once.
This works because every pipe operator returns a dataframe. If you add pipes, all you do is creating new data frames.  
  
example %>%  
&nbsp; mutate(new_column = old_column+1) %>% `mutate: create or alter columns`    
&nbsp; select(1:5)  `select: keep certain columns, here column 1 to 5`   

You can find a more detailed cheatsheet [here](https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf) or use the `help()` function.

***



***

### Info: ggplot2
The package `ggplot2` is a powerful data visualization package for `R`, which is part of the `tidyverse` environment. Besides basic functions that are also provided by native `R`, it allows the user to highly modify graphs by **altering**, **adding** or **removing** components.

The problem set doesn't require you to have any knowledge about functionalities of the package. However, you find further documentation [here](https://ggplot2.tidyverse.org/) or type `help(ggplot2)` into the console.

***



```{r "1__8"}
PaGP <- PaGP %>% 
  mutate(price_naturalgas_USA_normalized = price_naturalgas_USA * 3.412,
         price_naturalgas_Europe_normalized = price_naturalgas_Europe * 3.412,
         price_coal_australia_normalized = price_coal_australia * 0.453, 
         price_coal_africa_normalized = price_coal_africa * 0.453)
```

**Task:** Output a graphic. Just press *check*.
```{r "1__9"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$price_coal_australia_normalized, color="Coal Autralia"), size=1) +
  geom_line(aes(y=PaGP$price_coal_africa_normalized, color="Coal Africa"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_USA_normalized, color="Gas US"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_Europe_normalized, color="Gas Europe"), size=1) +
  labs(x = "Year", y = "", title = "Normalized Ressource Prices", subtitle = "Y=$/MwH")+
  scale_color_manual(name="Region",values = c("green", "yellow", "blue","red"))
```

////Text zu oben.


In the next Step we will look at the generated Power for Coal / Gas in the U.S. 




Quiz: Do you think that the proportion of gas generated electicity compared to coal generated electricity has increased or decreased over time?

- increased [x]

- decreased [ ]

&nbsp;




**Task:** Just press *check*.

```{r "1__10"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$generated_coal, color="Coal Generation (TWh)"), size=1, alpha=0.5) +
  geom_line(aes(y=PaGP$generated_gas, color="Natural Gas Generation (TWh)"), size=1, alpha=0.5) +
  labs(x = "Year", y = "", title = "Monthly Generation by Fueltype", subtitle = "Y=Monthly Electricty (TWh)")+
  scale_color_manual(name="",values = c("black","red"))+
  scale_y_continuous(breaks=seq(0,200,25))
```

////Text zu oben.



***

### Award: Starter Kit
Good Start! You will earn awards at the end of every chapter. At the end you will see how many you have earned.

***



## Exercise 2 -- Interconnections

![Interconnections](./Material/interconnections.png) (SOURCE)


***

### Info: Interconnections
The American Electric system is made up of three major `Interconnections`, which in turn concist of different balancing authorities (responsible for maintaining the electricity balance within the region).
Local electricity grids are hereby connected to form a network, which provides higher stablity and reliability of electricity. These `Interconnections` are operated independently of each other and, in contrast to the European electricity grid, there is little transfer of power.  
The 3 regions, as seen in the graph above, are as followed:
- Easter Interconnection: Consists of 36 balancing authorities and extends from the East Coast to the Rocky Mountains.
- Western Interconnection: Involves 37 balancing authorities, which are located in the West of North America.
- Electric Reliability Council of Texas (ERCOT): Consists of large parts of Texas

***


**Task:** Just press *check*.
```{r "2__11"}
Emissions <- read.csv("./Data/Emissions_Unit_Type.csv")
```



TODO!!


## Exercise 3 -- Road to a working model

In this chapter we will develop a model, which tries to find a connection between our given variables and CO2 emission. We will start from a simple linear approach and find our ways to a more complex but also more accurate model. We do not just stick to the 
&nbsp;
 - You can find a rough timeline of what we do in each chapter of this exercise below:
                
  + `Stage 1` - Exercise 3.1: Linear Regression
  + `Stage 2` - Exercise 3.2: Polonymal Regression
  + `Stage 3` - Exercise 3.3: Cubic Spline Regression
  + `Stage 4` - Exercise 3.4: More advanced Models??? Regression
&nbsp;

If you want to go faster through the problem set, you can skip to exercise `3.4`, which contains the final model and a brief overview of our results.  
In this exercise you will get a feeling for the data set you are working with and with some 


Erklaeren was wir machen usw.

Why are we splitting our analysis in different interconnections?

**Task:** Read in table.

```{r "3__12"}
data <- suppressMessages(read_csv("Data/main_data.csv"))
```



***

### Info: main_data
The data frame is a combination of data frames used in previous exercises and adds additional information. It contains `daily` information for each interconnection. Relevant columns are explained below:

`CO2MASS` = CO2 emissions in tons  
`gasprice` = Capacity weighted average daily gas price per interconnetion ($ per million BTU)  
`coal_price` = Price of Coal ($ per million BTU)  
`load` = daily electricity consumption per interconnection in MWH  
`meant` = average daily temperature per interconnection  
`nonFossil`
`so2price`
`netNSflow`

***



**Task:** Just press *check*.
```{r "3__13"}
table <- data %>% 
  group_by(intercn) %>% 
  select(intercn, CO2MASS, load, gasprice, coal_price) %>% 
  mutate(CO2MASS = CO2MASS/1000, load=load/1000, "Emission Rate"=CO2MASS/load, "Cost Ratio"=coal_price/gasprice) %>% 
  summarise_all("mean") %>% 
  rename("CO2 Emissions"=CO2MASS, Load=load, "Gas Price"=gasprice, "Coal Price"=coal_price)

table
```






**Task:** Just press *check*.
```{r "3__14"}
ggplot(data,aes(x=gasprice,y=CO2MASS,color=intercn))+
        geom_encircle(aes(group=intercn,fill=intercn),alpha=0.3) +
        theme_bw()+ 
        labs(y="CO2 Emissions", 
        x="Gas Price", 
        title="CO2 Emissions vs. Gasprice")
```

TEXT



## Exercise 3.1 -- E

**Task:** To load the data set `main_data.csv`, press `edit` and `check` afterwards.

```{r "3_1__15"}
data <- suppressMessages(read_csv("Data/main_data.csv"))
```

As we have seen in the previous exercise, the data heavily differ in the different `intersections`. 

As we have seen in the previous exercise it makes sense to calculate our model for each intersection separately. For this purpose we filter our data for intersection `EAST` and develop the model based on that. Afterwards we will use the model on on each intersection.
Since we observe substantial variation in coal and gas prices, we additionally add a new variable for relative costs `CR` (`Cost Ratio`), which is defined as below:

$CR=\frac{C_{coal}}{C_{gas}}$

//////////////CR ? CO2MASS/1000 EAJJAPODJAWPDJP

**Task:** The data set contains a column `intercn` with values `EAST`, `WEST` and `??`. Filter only for data with `intercn=="EAST"` and store the new data frame in variable `east`. 
```{r "3_1__16"}
# ... <- data %>% 
#  select(date, intercn, CO2MASS, coal_price, gasprice, meant, load, nonFossil) %>% 
#  mutate(CR = coal_price/gasprice, CO2MASS=CO2MASS/1000000) %>% 
#  filter(intercn=="...")
east <- data %>% 
  select(date, intercn, CO2MASS, coal_price, gasprice, meant, load, nonFossil) %>% 
  mutate(CR = coal_price/gasprice) %>%  #, CO2MASS=CO2MASS/1000000
  filter(intercn=="EAST")
```


### Stage 1: Linear Regression





```{r "3_1__17"}
fit <- lm(CO2MASS ~ CR, data=east)
```


***

### Info: Predict
`predict()`

***


INTERPRETATION LINEAR REGRESSION
**Task:** To
```{r "3_1__18"}
p1 <- predict(fit, newdata = east)
```

QUIZ: erwartung fallend oder steigend

**Task:** To
```{r "3_1__19"}
plot(CO2MASS~CR, east)
lines(east$CR, p1, col="red")
```


We will use the `stargazer()` function from the `stargazer` package to show summary statistics from our regressions. We don't need everything to know everything the basic functions displays, therefore we define a own custom function with statistics we need. Read below to find out more about `stargazer` and `custom functions` and continue with the next `task`.


***

### Info: Stargazer
`stargazer` provides specialised `HTML` formatting for regression tables and summary statistics tables. It is easy to use, supports a large number of different model types and formats data in a pleasing way. The basic function is called by `stargazer()`, but can be customized heavily. For more information run `help(stargazer)` or read on [here](https://cran.r-project.org/web/packages/stargazer/).

***



***

### Info: Custom functions
`R` provides an easy framework to add your own functions. The syntax is quite similar to other `Programming Languages` you could be familiar with. Once you have defined a function, you can use it as long as you are in the same session. Below you can find the basic structure of a function:

`myfunction <- function(arg1, arg2, ... ){`  
`statements`  
`return(object)`  
  
Here's an simple functions that adds `5` to the input integer and returns it.
  
`example <- function(x) {`  
  `x + 5`  
`}`  
`example(1)`
  
You can find more detailed information [here](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/function).

***


**Task:** Run the Code Chunk. It defines the function to show our custom regression tables.
```{r "3_1__20"}
regression.result= function(...){
  library(stargazer)
    stargazer(..., 
            type = "text", 
            style = "aer",  
            digits = 3,
            df = FALSE,
            report = "vct*",
            star.cutoffs = c(0.05, 0.01, 0.001),
            #model.names = FALSE,
            #object.names = TRUE,
            #model.numbers = FALSE, 
            omit.stat=c("f", "ser")
    )
} 
```



**Task:** Let's see what we just defined. Run the regression table for the linear model. Insert 
```{r "3_1__21"}
# regression.result(...)
regression.result(fit)
```

TEXT

**Task:** To
```{r "3_1__22"}
plot(fit, 1)
plot(fit, 2)
```

QQ PLOT RESIDUALS?


***

### Info: R-squared
`R-Squared` is a statistical measurement that represents the correlation between the fitted values of y (predited values) and the observed values (data you put into the regression formula). R-squared is always positive and ranges from 0 to 1. An `R-squared` value closer to 1 indicates that the suggested model explains a major portion of variance in the outcome variable.  
$R^{2}=1-\frac{Explained Variation}{Total Variation}$
The problem with `R-squared` measurement is, that it always increases with higher numbers of variables in the model, even if these variables are only weakly responsible for the predicted values. An solution is to take the number of variables into account, this is called `Adjusted R-Squared` and also shown in the summary output.

***


### Stage 2: Multivariate Regression

**Task:** Just press *check*.
```{r "3_1__23"}
CR.squared <- east$CR^2
fit2 <- lm(CO2MASS ~ CR + CR.squared, east)

CR.cubed <- east$CR^3
fit3 <- lm(CO2MASS ~ CR + + CR.squared + CR.cubed, east)
```

**Task:** Just press *check*.
```{r "3_1__24"}
p2 <- predict(fit2, east)
p3 <- predict(fit3, east)
```

**Task:** Just press *check*.
```{r "3_1__25"}
plot(CO2MASS ~ CR, east)    # plot points
lines(smooth.spline(east$CR, p1), col = "blue")
lines(smooth.spline(east$CR, p2), col = "red")
lines(smooth.spline(east$CR, p3), col = "green")# add regression line, using `predict` to generate y-values



plot(CO2MASS~CR, east)
lines(east$CR, p1, col="red")
lines(east$CR, p2, col="blue")
lines(east$CR, p3, col="green")
```

**Task:** Just press *check*.
```{r "3_1__26"}
regression.result(fit, fit2, fit3)
```

**Task:** Just press *check*.
```{r "3_1__27"}
anova(fit, fit2, fit3)
```


### Stage 3: Linear Regression

We came to the conclusion that it not enough to build a model purely arounnd `$CO_{2}$ emissions` and the `cost ratio` of gas and coal. In this section we will build a advanced model that includes several `addtitional variables`. The model is a `reduced-form regression` as follow:  
  
$CO_{2t}=s(CR_{t}|\beta)+s(load_{t}|\theta) + s(temp_t|\omega)+X_t\psi+\epsilon_t$



***

### Info: Meaning of Variables
`$CO_{2t}$` = CO2 emissions in tons  
`$CR_{t}$` = Capacity weighted average daily gas price per interconnetion ($ per million BTU)  
`$load_{t}$` = daily electricity consumption per interconnection in MWH  
`meant` = average daily temperature per interconnection  

$X_{t}$ = We include traditional factors like non-fossil electricity production (regenerative energies like solar, hydro or wind), 
`nonFossil`
`so2price`
`netNSflow`

***



First we will use ...

**Task:** Just press *check*.
```{r "3_1__28"}
fit4 <- lm(CO2MASS ~ CR + load + meant + nonFossil + so2price + netNSflow, east) 
```

**Task:** Just press *check*.
```{r "3_1__29"}
effectplot(fit4, show.ci = TRUE)
```

**Task:** Just press *check*.
```{r "3_1__30"}
regression.result(fit4)
```



https://datasciencebeginners.com/2018/12/20/multinomial-logistic-regression-using-r/



***

### Award: Linear Regression Expert
TEXT

***



## Exercise 4.1 -- Estimated CO2 Response to Fuel Prices


In this exercise we will use the findings we got in the last chapter and visualize our results. We will use the multivariate model we defined in the last exercise.

Before going into plotting our results, we have to introduce some new ideas on how to plot our model.

We will use cubic splines on our model 

What are Cubic Splines?





Datensatz aendern, sodass 3.2.2 rausfliegt?

**Task:** Just press *check*.
```{r "4_1__31"}
data <- read_csv("Data/main_data.csv")
```

**Task:** Just press *check*.
```{r "4_1__32"}
# Exemplarisch fuer "EAST Interconnection"

dat <- data %>% 
  select(date, intercn, CO2MASS, coal_price, gasprice, meant, load, nonFossil, so2price, netNSflow) %>% 
  mutate(CR = coal_price/gasprice, CO2MASS=CO2MASS/1000000)
```

**Task:** Just press *check*.
```{r "4_1__33"}
dat_east <- dat %>% filter(intercn=="EAST")

dat_wecc <- dat %>% filter(intercn=="WECC")

dat_ercot <- dat %>%  filter(intercn=="ERCOT")
```


**Task:** Just press *check*.
```{r "4_1__34"}
model <- CO2MASS ~ gasprice + load + meant + nonFossil + so2price + netNSflow
model2 <- CO2MASS ~ s(gasprice, bs = 'cr', k=6) + s(meant, bs= 're') + s(load, bs= 're') + s(load, bs= 're') + s(load, bs= 're') 
```

**Task:** Just press *check*.
```{r "4_1__35"}
fit_east <- lm(model, data = dat_east)
fit_wecc <- lm(model, data = dat_wecc)
fit_ercot <- lm(model, data = dat_ercot)
```

**Task:** Just press *check*.
```{r "4_1__36"}
####### Plot result for Interconnection "EAST"
CO2_pred_east2 <- data.frame(CO2MASS = dat_east$CO2MASS,
                       gasprice = dat_east$gasprice,
                       predicted_values = predict(fit_east, newdata = dat_east))

#find predicted CO2MASS at gas base price = 5.75?

#calculate percentage change to base 
CO2_pred_east <- CO2_pred_east2 %>% 
  mutate(predicted_values_perc = predicted_values/5.305963-1)

#save plot to variable
plot_east <- ggplot(CO2_pred_east, aes(x=gasprice, y=CO2MASS) ) +
  geom_smooth(aes(y = predicted_values_perc), colour = "red", method="gam", formula = y ~ splines::bs(x, 5)) +
  #stat_smooth(aes(y=predicted_values_perc))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(limits=c(2, 12)) +
  geom_vline(xintercept = 5.75, linetype = "dashed")
 # scale_x_reverse()

####### Plot result for Interconnection "ERCOT"
CO2_pred_ercot2 <- data.frame(CO2MASS = dat_ercot$CO2MASS,
                       gasprice = dat_ercot$gasprice,
                       predicted_values = predict(fit_ercot, newdata = dat_ercot))

#find predicted CO2MASS at gas base price = 5.75?

#calculate percentage change to base 
CO2_pred_ercot <- CO2_pred_ercot2 %>% 
  mutate(predicted_values_perc = predicted_values/0.5676612-1)

#save plot to variable
plot_ercot <- ggplot(CO2_pred_ercot, aes(x=gasprice, y=CO2MASS) ) +
  geom_smooth(aes(y = predicted_values_perc), colour = "red", method="gam", formula = y ~ splines::bs(x, 5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(limits=c(2, 12)) +
  geom_vline(xintercept = 5.75, linetype = "dashed")
 # scale_x_reverse()


####### Plot result for Interconnection "WECC"
CO2_pred_wecc2 <- data.frame(CO2MASS = dat_wecc$CO2MASS,
                       gasprice = dat_wecc$gasprice,
                       predicted_values = predict(fit_wecc, newdata = dat_wecc))

#find predicted CO2MASS at gas base price = 5.75?

#calculate percentage change to base 
CO2_pred_wecc <- CO2_pred_wecc2 %>% 
  mutate(predicted_values_perc = predicted_values/0.9217305-1)

#save plot to variable
plot_wecc <- ggplot(CO2_pred_wecc, aes(x=gasprice, y=CO2MASS) ) +
  geom_smooth(aes(y = predicted_values_perc), colour = "red", method="gam", formula = y ~ splines::bs(x, 5)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(limits=c(2, 12)) +
  geom_vline(xintercept = 5.75, linetype = "dashed")
 # scale_x_reverse()
```

**Task:** Just press *check*.
```{r "4_1__37"}
plot_east
plot_ercot
plot_wecc
```



***

### Award: Spine Surgeon
This was a critical operation, but you mastered it! Keep going, the hardest part is over.

***


## Exercise 4.2 --  Imputed CO2 Response to Carbon Prices

$CR=\frac{C_{coal}}{C_{gas}}=\frac{P_{coal}+CO_{2,coal}P_{co2}}{P_{gas}+CO_{2,gas}P_{co2}}$

Figure 7


## Exercise 5 -- Conclusion


```{r "5__38"}
awards()
```


## Exercise References


### Bibliography

- Cullen, Joseph A., and Erin T. Mansur. 2017. "Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach Using the Shale Revolution." American Economic Journal: Economic Policy, 9 (3): 106-33.

- Lafrancois, B. A. (2012), ‘A lot left over: Reducing CO2 emissions in the United States’ electric power sector through the use of natural gas’, Energy Policy 50, 428–435.


### R Packages

- Hlavac, Marek (2018). stargazer: Well-Formatted Regression and Summary Statistics Tables.
 R package version 5.2.2. https://CRAN.R-project.org/package=stargazer 

- Kranz, S. (2015): RTutor. "Creating R problem sets with automatic assessment of student's solutions", R package version 2019.10.11, https://github.com/skranz/RTutor

- Wickham, H. (2016): ggplot2. "Elegant Graphics for Data Analysis", Springer-Verlag, New York, R package version 3.2.1, http://CRAN.R-project.org/package=ggplot2

- Wickham, H., Francois, R., Henry, L., Muller, K., (2018): dplyr. "A Grammar of Data Manipulation", R package version 0.8.3, http://CRAN.R-project.org/package=dplyr


 
### Data Sources

- Federal Energy Regulatory Comission, "Form  No. 714 Annual Electric Balancing Authority Area
and Planning Area Report", https://www.ferc.gov/docs-filing/forms/form-714/data.asp

- The World Bank , "Commodity Markets Monthly Prices",  https://www.worldbank.org/en/research/commodity-markets

- U.S. Energy Information Administration, "Form EIA-923", https://www.eia.gov/electricity/data.php#generation


*All of the above links were accessable as of March 31, 2020.*

