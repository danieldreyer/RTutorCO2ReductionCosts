# Problem Set: Estimating CO2 Reduction Costs


```{r 'check_ps', include=FALSE}

user.name = '' # set to your user name

# To check your problem set, save your file (Ctrl-S) and then run the RStudio Addin 'Check Problemset'

# Alternatively run the following lines 
library(RTutor)
ps.dir = getwd() # directory of this file
ps.file = 'CarbonReductionCosts.Rmd' # name of this file
check.problem.set('CarbonReductionCosts', ps.dir, ps.file, user.name=user.name, reset=FALSE)
```


Author: Daniel Dreyer



Welcome to this interactive problem set. The awareness of climate change rose significantly over the past years. Purely questioning the moral of the population though, won't avoid its' highly uncertain effects. Therefore high efforts are made to find technical improvements as well as economical incentitives to avoid long term effects of climate change.   
In this problem set we will approach one possible countermeasure by analysing how carbon pricing would reduce emissions in the electricty sector. The analysis is based on **"Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach using the Shale Revolution"** by Joseph A. Cullen, Erin T. Mansur (2016) - further simply referred as Cullen. The paper and further ressources can be downloaded from <a href="https://www.aeaweb.org/articles?id=10.1257/pol.20150388   target = "_blank"> https://www.aeaweb.org/articles?id=10.1257/pol.20150388</a>

You will use the `Statstical Programming Language R` to replicate the analysis. Basic knowledge of `R` is required, but information on important function will be provided. 
Since each new exercise inherits the results of previous exercises, it is recommendated to solve them in order. However you are free to skip to any exercise you like if you feel so.  
If you are a complete novice in `R` you should not feel left behind. Understanding the basic concepts is straight forward, you can find useful information [here](https://cran.r-project.org/manuals.html).



### Contents

$\qquad$  Overview
  
$\qquad$  1 TBA

$\qquad$  2 TBA

$\qquad$ $\qquad$ 2.1 

$\qquad$  3 TBA

$\qquad$  4 TBA

$\qquad$  5 Conclusion

$\qquad$ References


## Exercise Content

$\qquad$ *Exercise 1* - Motivation (rename later)

$\qquad$ *Exercise 2* - TBA

$\qquad$ *Exercise 3* - TBA

$\qquad$ *Exercise 4* - TBA

$\qquad$ *Exercise 5* - TBA


### ReadME


The problem set offers different ways to interact with it. Coding exercises are marked as **TASK**. Some only need to be run, for others you need to complement a small part of the code, which is noted in the task description. Below you can read about the different types of interactions with their corresponding functions:   


 - Code Chunks: Require you to complete small parts of Code. The work flow of solving code chunks is intuitive and as follows:
                
  + `edit` : Click to insert your own Code into the chunk.
  + `run chunk`: Runs the chunk and displays outputs or errors in the corresponding console.
  + `check`: Check your input for against the solution.
  + `hint` : Should you have problem to solve a task, you can request a hint.  
&nbsp;

  
  Additional functions:    
                   
  + `data`: Redirects you to the data browser - you can view the loaded data with the help of an interface.
  + `solution` : Shows the solution of the task.  
&nbsp;

  
 - Quizzes: Evaluate your knownledge of topics before we dive in our analysis.
    
 - Info Boxes: Contain additional information on technical terms or documentation of functions.
 

After you finish a chapter, click `Go to next exercise` on the bottom or navigate around with the help of the bar on top.


## Exercise 1 -- Motivation

`Coal` is the **world's biggest source of energy and carbon emissions**, mostly because it is easy to store, transport, doesn't alter and can be mined in huge quantities around the world. This makes it desirable and cheap to use as a energy source. Given that the coal supply will last for decades, it is a major goal to find incentitives to reduce emissions from coal consumption.  
One alternative to coal is `natural gas`. Even though still being a fossil fuel, its' emissions and heat density are way superior to coal. Nevertheless, natural gas wasn't considered to be an real alternative to coal because to its higher prices more difficult handling up until the early 2000s.  
This changed due to the `Shale Revolution`, whereby natural gas was not only a by-product of the oil industry, but could now be extracted in a targeted manner and in large quantities. Lanfrancois (2012) estimates, that based on the Clean Power Plan introduced by the Obama administration in 2015, carbon dioxide emissions from the electricity industry could be reduced by 23 to 42 percent by switching existing coal powered generators to gas powered ones.  
  
info("Shale-Revolution") # Run this line (Strg-Enter) to show info
  
With this in mind, in `Exercise 1` you will explore data to get insights in the current situation of the U.S. energy sector. You will look at the distribution of energy sources in the American market, its prices and the generated load over time.  

**Task:**
Use the `read_csv` command to *load the data set* and store it in a variable called `PaGP`.
The basic structure of the command is already given in the code chunk as a comment.

info("read.csv() and write.csv()") # Run this line (Strg-Enter) to show info

```{r "1__5"}
# ... <- read_csv("./Data/PaGP.csv")
```


**Task:** Lets take a look at the data we just imported. Use the `head()` command to show the first **eight** rows of the data set. 


```{r "1__6"}
# head(PaGP, ...)
```


Alternatively you can press the `data` button to get redirected to the `Data Explorer` Tab. 

The date column is currently stored as a character. To be able visualize the date variable as a continuous variable, we have to convert is. Therefore, R has a build in date class.  
**Task:** Just press *check*.

```{r "1__7"}
PaGP <- as.data.frame(PaGP)
PaGP$date <- as.Date(PaGP$date)
```

  
The data frame contains monthly numbers of generated MwH with coal and gas as well as prices of Energy commodities. 
Keep in mind that different commodities are traded in different units. Oil is traded in barrels (\$/bbl), coal in metric tons (\$/mt) and gas in British thermal units($/mmbtu). The natural gas index is set to 100 in the year 2010 and changes accordingly.
Prior to visualizing the data and to get clearer results, lets modifiy the data set. As mentioned before, commodities are traded in different units. Therefore we will add new entries for normalized prices, which gives us a good cost basis to produce the same amount of energy with each commodity.  On this account, we assume that `1 MwH = 0.454 mT Coal = 3.412 mmBtu Natural Gas`.

**Task:** Perform the above calculations. Just press *check*.
  
info("Pipe, mutate, select") # Run this line (Strg-Enter) to show info

info("ggplot2") # Run this line (Strg-Enter) to show info


```{r "1__8"}
```

**Task:** Output a graphic. Just press *check*.
```{r "1__9"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$price_coal_australia_normalized, color="Coal Autralia"), size=1) +
  geom_line(aes(y=PaGP$price_coal_africa_normalized, color="Coal Africa"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_USA_normalized, color="Gas US"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_Europe_normalized, color="Gas Europe"), size=1) +
  labs(x = "Year", y = "", title = "Normalized Ressource Prices", subtitle = "Y=$/MwH")+
  scale_color_manual(name="Region",values = c("green", "yellow", "blue","red"))
```

TEXT


In the next Step we will look at the generated Power for Coal / Gas in the U.S. 



#! addon__quiz__Proportion of Sectors
&nbsp;




**Task:** Just press *check*.

```{r "1__10"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$generated_coal, color="Coal Generation (TWh)"), size=1, alpha=0.5) +
  geom_line(aes(y=PaGP$generated_gas, color="Natural Gas Generation (TWh)"), size=1, alpha=0.5) +
  labs(x = "Year", y = "", title = "Monthly Generation by Fueltype", subtitle = "Y=Monthly Electricty (TWh)")+
  scale_color_manual(name="",values = c("black","red"))+
  scale_y_continuous(breaks=seq(0,200,25))
```

TEXT



## Exercise 2 -- Interconnections

![Interconnections](./Material/interconnections.png) (SOURCE)

info("Interconnections") # Run this line (Strg-Enter) to show info

**Task:** Just press *check*.
```{r "2"}
Emissions <- read.csv("./Data/Emissions_Unit_Type.csv")
```

wip



### theory behind mapping carbon prices


$$\tag{1}MC=HR\cdot(P_{fuel}+CO_{2,fuel}\cdot P_{co2})=HR\cdot C_{fuel}$$




## Exercise 3 -- Road to a working model

In this and the following exercies we will develop a statistical model, that tries to find a connection between our given variables and CO2 emission. We will start from a simple linear approach and find our ways to a more complex but also more accurate model. We do not just stick to the 
&nbsp;
 - You can find a rough guideline of content in each exercise below:
                
  + `Exercise 3.1` - Linear Regression
  + `Exercise 3.2` - Polonymal Regression
  + `Exercise 3.3` - Cubic Spline Regression
&nbsp;

If you want to go faster through the problem set, you can skip to exercise `3.3` onwards, which presents the final model and visualizes our results.  
In this exercise you will get a feeling for the data set you are working with and with some 

The goal of this exercise is to give you an overview of the data we use to perform our analysis. 

TEXT

**Task:** Read in table.

```{r "3"}
data <- suppressMessages(read_csv("Data/main_data.csv"))
```


info("main_data") # Run this line (Strg-Enter) to show info


**Task:** Just press *check*.
```{r "3__2"}
table <- data %>% 
  group_by(intercn) %>% 
  select(intercn, CO2MASS, load, gasprice, coal_price) %>% 
  mutate(CO2MASS = CO2MASS/1000, load=load/1000, "Emission Rate"=CO2MASS/load, "Cost Ratio"=coal_price/gasprice) %>% 
  summarise_all("mean") %>% 
  rename("CO2 Emissions"=CO2MASS, Load=load, "Gas Price"=gasprice, "Coal Price"=coal_price)

table
```

**Task:** Just press *check*.
```{r "3__3"}
ggplot(data,aes(x=gasprice,y=CO2MASS,color=intercn))+
        geom_encircle(aes(group=intercn,fill=intercn),alpha=0.3) +
        theme_bw()+ 
        labs(y="CO2 Emissions", 
        x="Gas Price", 
        title="CO2 Emissions vs. Gasprice")
```

TEXT

## Exercise 3.1 -- Priceratio Regressions

In this and the following chapter we will take a look at regression theory and develop a model that satifies our statistical needs and answer our initial question on how changing commodity prices will effect $CO_2$ emissions. We start with simple regressions and introduce new methods along the way to make our model more precise.

**Task:** To get started, load the data set `main_data.csv`, press `edit` and `check` afterwards.

```{r "3_1"}
dat <- suppressMessages(read_csv("Data/main_data.csv"))
```

We have seen in the previous exercise that it makes sense to calculate our model for each intersection separately. For this purpose we filter our data for intersection `EAST` and develop the model based on that `intersection`. Afterwards we will use the model on each intersection. Since we observe substantial variation in coal and gas prices, we construct a new variable for relative costs `priceratio`. There are several ways to propose price ratios, we use the ratio between the price of coal and gas, which is defined as followed:  

As we have seen in the last chapter it makes sense to apply our analysis for each intersection `separately`. For this reason the data are divided into interconnections. We `develop` our model based on the `EAST` interconnection and map the model to all at a later point in time.  







$CR=\frac{C_{coal}}{C_{gas}}=\frac{P_{coal}+CO_{2,coal}\cdot P_{co2}}{P_{gas}+CO_{2,gas}\cdot P_{co2}}(2)$



**Task:** The data set contains a column `intercn` with values `EAST`, `WEST` and `ERCOT`. Filter only for data with interconnection `EAST` and store the new data frame in variable `dat_east`. Additionally, calculate the cost ratio between `coalprice` and `gasprice`.
```{r "3_1__2"}
# ... <- data %>% 
#  mutate(CR = .../...) %>% 
#  filter(intercn=="...")

```


### Stage 1: Linear Regression

Highly unlikely here, but to get you rolling in the topic, lets start with a simple linear regression and analyse the results on fitting. I will introduce methods to interpret regression results ...


info("Linear Regression with lm()") # Run this line (Strg-Enter) to show info

**Task:** Run a regression with `co2mass` as the dependent variable and `pricerati` as independent variable. Store it in the variable `fit1`. 
```{r "3_1__4"}
# ... <- lm(...~... , data=east)

```



Before we look at our results, answer this quiz. 

#! addon__quiz__Reg1


TEXT

**Task:** To
```{r "3_1__5"}
summary(fit)
```





**Task:** To
```{r "3_1__6"}

```

QUIZ: erwartung fallend oder steigend

info("Predict") # Run this line (Strg-Enter) to show info

**Task:** To
```{r "3_1__7"}

```


We will use the `stargazer()` function from the `stargazer` package to show summary statistics from our regressions. We don't need everything to know everything the basic functions displays, therefore we define a own custom function with statistics we need. Read below to find out more about `stargazer` and `custom functions` and continue with the next `task`.

info("Stargazer") # Run this line (Strg-Enter) to show info

info("Custom functions") # Run this line (Strg-Enter) to show info

**Task:** Run the Code Chunk. It defines the function to show our custom regression tables.
```{r "3_1__10"}
show.regression= function(...){
  library(stargazer)
    stargazer(..., 
            type = "text", 
            style = "aer",  
            digits = 3,
            df = FALSE,
            report = "vct*",
            star.cutoffs = c(0.05, 0.01, 0.001),
            model.names = FALSE,
            object.names = TRUE,
            model.numbers = FALSE, 
            omit.stat=c("f", "ser")
    )
} 
```



**Task:** Let's see what we just defined. Run the regression table for the linear model. Insert 
```{r "3_1__11"}
# regression.result(...)

```

TEXT

**Task:** To
```{r "3_1__12"}

```

QQ PLOT RESIDUALS?

info("R-squared") # Run this line (Strg-Enter) to show info

### Stage 2: Polonymal Regression

**Task:** Just press *check*.
```{r "3_1__13"}

```

**Task:** Just press *check*.
```{r "3_1__14"}

```

**Task:** Just press *check*.
```{r "3_1__15"}

```

**Task:** Just press *check*.
```{r "3_1__16"}

```

**Task:** Just press *check*.
```{r "3_1__17"}

```










## Exercise 3.2 -- Restricted Spline Regressions

### Stage 3: Cubic Spline

In previous stages we came to the conclusion that a model that relies purely on `$CO_{2}$ emissions` and the `Cost Ratio` of gas and coal isn't sufficient to explain the real-life situation. In this `Stage` we will extend the model and add several `independent variables`.  
The model is a `reduced-form regression` and is defined as followed:

#! start_note "Cubic Splines?"
Explain Cubic Splines

```{r "3_2",optional=TRUE}
# show that all integers between 0 and 10
```

#! end_note

info("Model variables") # Run this line (Strg-Enter) to show info

First, we have to define our model 

**Task:** Just press *check*.
```{r "3_2__2"}

```



**Task:** Just press *check*.
```{r "3_2__3"}

```

**Task:** Just press *check*.
```{r "3_2__4"}

```




## Exercise 3.3 -- Estimated CO2 Response to Fuel Prices

In this exercise we will use the model we constructed in the last chapter and visualize our results. Before going into plotting our results, we have to introduce some new ideas on how to plot our model.
 
In this exercise we will extend our results from the previous exercise and estimate the $CO_{2}$ respone to changing fuel prices. 


To summarise the results from last exercises and to understand why we do certain methods this way, lets summarise. In exercise ?.? we showed that it makes sense to split our analysis in different connection. 

 
 
$CO_{2t}=s(CR_{t}|\beta)+s(load_{t}|\theta) + s(temp_t|\omega)+X_t\psi+\epsilon_t$ 
 
 




```{r "3_3"}
```


```{r "3_3__2"}
```

```{r "3_3__3"}
```

```{r "3_3__4"}
```

```{r "3_3__5"}
```

```{r "3_3__6"}
```

```{r "3_3__7"}
```

```{r "3_3__8"}
```


EVtl loop ueber "WECC" und "ERCOT"

**Task:** Just press *check*.
```{r "3_3__9"}

```



**Task:** Just press *check*.
```{r "3_3__10"}

```



```{r "3_3__11"}
```















## Exercise 3.4 --  Imputed CO2 Response to Carbon Prices


The first step is the same as in the last exercise, but we need it for this part too. You can just run the code below. If you have skipped to this exercise and dont understand what it does you should go back to the previous exercise.

${P_{co2}}=\frac{CR\cdot{P_{gas}}-{P_{coal}}}{CO_{2,coal}-CR\cdot CO_{2,gas}}$

**Task:** Just press *check*.
```{r "3_4"}

```

**Task:** Just press *check*.
```{r "3_4__2"}

```

**Task:** Just press *check*.
```{r "3_4__3"}

```

**Task:** Just press *check*.
```{r "3_4__4"}

```


**Task:** Just press *check*.
```{r "3_4__5"}

```

**Task:** Just press *check*.







## Exercise 4 -- Conclusion


```{r "4"}
awards()
```


## Exercise References


### Bibliography

- Cullen, Joseph A., and Erin T. Mansur. 2017. "Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach Using the Shale Revolution." American Economic Journal: Economic Policy, 9 (3): 106-33.

- Lafrancois, B. A. (2012), ‘A lot left over: Reducing CO2 emissions in the United States’ electric power sector through the use of natural gas’, Energy Policy 50, 428–435.


### R Packages

- Hlavac, Marek (2018). stargazer: Well-Formatted Regression and Summary Statistics Tables.
 R package version 5.2.2. https://CRAN.R-project.org/package=stargazer 

- Kranz, S. (2015): RTutor. "Creating R problem sets with automatic assessment of student's solutions", R package version 2019.10.11, https://github.com/skranz/RTutor

- Wickham, H. (2016): ggplot2. "Elegant Graphics for Data Analysis", Springer-Verlag, New York, R package version 3.2.1, http://CRAN.R-project.org/package=ggplot2

- Wickham, H., Francois, R., Henry, L., Muller, K., (2018): dplyr. "A Grammar of Data Manipulation", R package version 0.8.3, http://CRAN.R-project.org/package=dplyr


 
### Data Sources

- Federal Energy Regulatory Comission, "Form  No. 714 Annual Electric Balancing Authority Area
and Planning Area Report", https://www.ferc.gov/docs-filing/forms/form-714/data.asp

- The World Bank , "Commodity Markets Monthly Prices",  https://www.worldbank.org/en/research/commodity-markets

- U.S. Energy Information Administration, "Form EIA-923", https://www.eia.gov/electricity/data.php#generation


*All of the above links were accessable as of March 31, 2020.*

