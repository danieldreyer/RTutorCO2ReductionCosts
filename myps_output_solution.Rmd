
---
title: Problem Set myps
output: 
  html_document: 
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE, echo=FALSE}
# Load libraries and source extra code
library(dplyr)
library(ggplot2)
library(choroplethr)
library(lfe)
library(gridExtra)
library(evd)
library(htmlTable)
library(stargazer)
library(magick)
library(reshape2)
library(pracma)
library(haven)
library(RTutor)


# Options for rendering data frames
# If you knit to a Word docx file, try
# 
# data.frame.theme="word" 
# 
# (needs RStudio > 1.2.1)
# 
# You can also set the options like
# table.max.cols as chunk options
# Makes sense if there are too many, too wide
# columns in some chunks

RTutor::set.knit.print.opts(data.frame.theme="code", table.max.rows=25, table.max.cols=NULL, round.digits=5, signif.digits=8)


# continue knitting even if there is an error
knitr::opts_chunk$set(error = TRUE) 
```

# Problem Set: Estimating Carbon Dioxide reduction costs

Author: Daniel Dreyer



Welcome to this interactive problem set. The awareness of climate change rose significantly over the past years. Sorely questioning the moral of the population won't avoid its' highly uncertain effects. Therefore high efforts are made to find technical improvements as well as economical incentitives to avoid long term effects of climate change.   
In this problem set we will approach one possible countermeasure by analysing how carbon pricing would reduce emissions in the electricty sector. The analysis is based on **"Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach using the Shale Revolution"** by Joseph A. Cullen, Erin T. Mansur (2016) - further simply referred as Cullen. The paper and further ressources can be downloaded from <a href="https://www.aeaweb.org/articles?id=10.1257/pol.20150388   target = "_blank"> https://www.aeaweb.org/articles?id=10.1257/pol.20150388</a>

You will use the `Statstical Programming Language R` to replicate the analysis. Basic Knowledge is required , but further information on important logic or function will be provided. Furthermore, you are not forced to solve the tasks in order, but it is recommended, since each new task is based on the results of the previous ones. Even if you are a complete novice in R you should not be put off here. You can find useful information 
[here](https://cran.r-project.org/manuals.html).



### Contents

$\qquad$  Overview
  
$\qquad$  1

$\qquad$  2

$\qquad$ $\qquad$ 2.1 

$\qquad$  3 

$\qquad$  4

$\qquad$  8 Conclusion

$\qquad$ References


## Exercise Content

$\qquad$ *Exercise 1* - Motivation // evtl. aufteilen in Motivation, Daten, deskr. Analyse?

$\qquad$ *Exercise 2* - TBA

$\qquad$ *Exercise 3* - TBA

$\qquad$ *Exercise 4* - TBA

$\qquad$ *Exercise 5* - TBA


### ReadME


The problem set offers different ways to interact with. Coding exercises are marked as **TASK**. Some only require you to run them, in others you need to complement a small part of the code. Below the different types of interactions with their corresponding functions are explained:   


 - Code Chunks: Require you to complete small parts of Code. The work flow of solving code chunks is intuitive and as follows:
                
  + `edit` : Click to insert your own Code into the chunk.
  + `run chunk`: Runs the chunk and displays the outputs in the corresponding console of the task.
  + `check`: Check your input for correctness.  
&nbsp;

  
  Additional functions:    
                   
  + `data`: Redirects you to the data browser - you can view the data that are loaded.
  + `hint` : Shows a hint to help solve the code chunk.
  + `solution` : Shows the solution of the task.  
&nbsp;

  
 - Quizzes: To give you a feeling of the data we work with, i placed some quizzes to blabal
    
 - Info Boxes: Contain additional information, that provide further information on technical terms and documentation of functions.
 

After you finish a chapter, click `Go to next exercise` on the bottom or navigate around with the help of the bar on top.


## Exercise 1 -- Motivation

The goal of this problem set is to analyse how carbon pricing would effect emission in the energy sector. `Coal` is the **world's biggest source of energy and carbon emissions**, mostly because it is easy to store, transport, doesn't alter and can be mined in huge quantities around the world. This makes it very desirable and cheap to use as a energy source. Given that the coal supply will last for decades, it is a major goal to find incentitives to reduce emissions from coal consumption.  
One alternative to coal is `natural gas`. Even though it is still considered fossil fuel, its emissions and heat density are way superior to coal. Nevertheless, natural gas wasn't considered to be an real alternative to coal  as an energy supplier until the early 2000s due to its higher prices and the more difficult handling.  
This has changed due to the `Shale Revolution`, whereby natural gas was not only a by-product of the oil industry, but could now be extracted in a targeted manner and in large quantities. Lanfrancois (2012) estimates, based on the Clean Power Plan introduced by the Obama administration in 2015, carbon dioxide emissions from the electricity industry could be reduced by 23 to 42 percent by switching existing coal powered generators to gas powered ones.  
  

***

### Info: Shale-Revolution
Shale gas is a form of natural gas and is extracted from shale formation, known as fracking. Since the start of the century, shale gas became a increasingly more important source of natural gas in the United States. Whereas in 2000 shale gas only provided 1% of the natural gas, nowadays in 2020 it makes up roughly 50%.
However at the same time, the environmental concerns of fracking are heavily debated.  

Further information on the topic can be found here:  
<a href="https://en.wikipedia.org/wiki/Shale_ga   target = "_blank"> https://en.wikipedia.org/wiki/Shale_gas</a>s  
<a href="https://en.wikipedia.org/wiki/Hydraulic_fracturing   target = "_blank"> https://en.wikipedia.org/wiki/Hydraulic_fracturing</a>

***

  
With this in mind, in `Exercise 1` you will explore various data to get insights in the current situation of the U.S. energy sector. You will look at the distribution of energy sources in the American market, its prices and the generated load over time.
The data sets are provided by ???????




**Task:**
Use the `read.csv` command to *load the data set* and store it in a variable called `PaGP`.
The basic structure of the command is already given in the code chunk as a comment.


***

### Info: read.csv() and write.csv()
The command `read.csv()` reads in a **csv file** and stores it into a given name. Csv is a format for data, that uses commas as seperators and periods as decimals. Another version of are **csv2 files**, where semicolons are used for seperators and commas for decimals. We only use csv files here.

Given the file you want to read it is in the same working directory, you can use the command below:

```{r "1",eval=FALSE}
example <- read.csv("example.csv")
```

If the file is saved outside of your working directory there are two possibilities. For one you can insert the whole file path, if the file is you can navigate through the whole file path if your file is above 

If the file is saved in an structure above your working directory you have to additionally insert the full file path:

```{r "1__2",eval=FALSE}
example <- read.csv("C:/Data/example.csv")
```

For files that are located below the working directory it is sufficient to specify the following file path:

```{r "1__3",eval=FALSE}
example <- read.csv("./Data/example.csv")
```


Csv files can be saved using the `write.csv` command.

```{r "1__4",eval=FALSE}
write.csv(example, file="example.csv")
```

For further information, use `help(write.csv)`.

***


```{r "1__5"}
# ... <- read.csv("./Data/data_1.csv")
PaGP <- read.csv("./Data/PaGP.csv")
```

```{r "1__6"}
PaGP <- as.data.frame(PaGP)
PaGP$date <- as.Date(PaGP$date)


PaGP <- PaGP %>% 
  select(c(1:5, 10:13))
```



**Task:** Lets take a look at the data we just imported. Use the `head()` command to show the first **eight** rows of the data set. 


```{r "1__7"}
# head(PaGP, ...)
head(PaGP, 8)

```


Alternatively you can press the `data` button to get redirected to the `Data Explorer` Tab.  
  
The data frame contains monthly numbers of generated MwH with coal and gas as well as prices of Energy commodities. 
Keep in mind that different commodities are traded in different units. Oil is traded in barrels ($/bbl), coal in metric tons ($/mt) and gas in British thermal units($/mmbtu). The natural gas index is set to 100 in the year 2010 and changes accordingly.
Prior to visualizing the data, we should clean the data set. First, as we are just interested in coal and natural gas, the other commodities prices can be removed. Secondly, as mentioned above, commodities are traded in different units. Therefore we will add new entries for normalized prices, which gives us a good cost basis to produce the same amount of energy with each commodity.  On this account, we assume that `1 MwH = 0.454 mT Coal = 3.412 mmBtu Natural Gas`.

The date column is currently stored as a character. To be able visualize the date variable as a continuous variable, we have to convert is. Therefore, R has a build in date class.
**Task:** Just press *check*.

```{r "1__8"}
PaGP <- as.data.frame(PaGP)
PaGP$date <- as.Date(PaGP$date)
```



**Task:** Perform the above data cleaning and calculations. Just press *check*.
  

***

### Info: Pipe, mutate, select
The pipe operator `%>%` is a feature provided by the `dplyr` Package. Essentially it allows to exectute multiple operation on a dataframe at once.
This works because every pipe operator returns a dataframe. If you add pipes, all you do is creating new data frames.  
  
example %>%  
&nbsp; mutate(new_column = old_column+1) %>% `mutate: create or alter columns`    
&nbsp; select(1:5)  `select: keep certain columns, here column 1 to 5`   

You can find a more detailed cheatsheet here [here](https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf) or use the `help()` function.

***



***

### Info: ggplot2
The package `ggplot2` is a powerful data visualization package for `R`, which is part of the `tidyverse` environment. Besides basic functions that are also provided by native `R`, it allows the user to highly modify graphs by **altering**, **adding** or **removing** components.

The problem set doesn't require you to have any knowledge about functionalities of the package. However, you find further documentation [here](https://ggplot2.tidyverse.org/) or type `help(ggplot2)` into the console.

***




```{r "1__9"}
PaGP <- PaGP %>% 
  #select(c(1:5, 10:13)) %>%
  mutate(price_naturalgas_USA_normalized = price_naturalgas_USA * 3.412) %>% 
  mutate(price_naturalgas_Europe_normalized = price_naturalgas_Europe * 3.412) %>% 
  mutate(price_coal_australia_normalized = price_coal_australia * 0.453) %>% 
  mutate(price_coal_africa_normalized = price_coal_africa * 0.453)
```

**Task:** Output a graphic. Just press *check*.
```{r "1__10"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$price_coal_australia_normalized, color="Coal Autralia"), size=1) +
  geom_line(aes(y=PaGP$price_coal_africa_normalized, color="Coal Africa"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_USA_normalized, color="Gas US"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_Europe_normalized, color="Gas Europe"), size=1) +
  labs(x = "Year", y = "", title = "Normalized Ressource Prices", subtitle = "Y=$/MwH")+
  scale_color_manual(name="Region",values = c("green", "yellow", "blue","red"))
```

Text zu oben.


In the next Step we will look at the generated Power for Coal / Gas in the U.S. 




Quiz: Do you think that the proportion of gas generated electicity compared to coal generated electricity has increased or decreased over time?

- increased [x]

- decreased [ ]

&nbsp;




**Task:** Just press *check*.

```{r "1__11"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$generated_coal, color="Coal Generation (TWh)"), size=1) +
  geom_line(aes(y=PaGP$generated_gas, color="Natural Gas Generation (TWh)"), size=1, linetype="dotted") +
  labs(x = "Year", y = "", title = "Monthly Generation by Fueltype", subtitle = "Y=Monthly Electricty (TWh)")+
  scale_color_manual(name="",values = c("black","red"))+
  scale_y_continuous(breaks=seq(0,200,25))
```












**Task:** Just press *check*.

```{r "1__12"}
ggplot(data=PaGP, aes(x=date)) +
  geom_line(aes(y=PaGP$price_coal_australia, color="Coal Autralia"), size=1) +
  geom_line(aes(y=PaGP$price_coal_africa, color="Coal Africa"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_USA, color="Gas US"), size=1) +
  geom_line(aes(y=PaGP$price_naturalgas_Europe, color="Gas Europe"), size=1) +
  labs(x = "Year", y = "", title = "Ressource Prices", subtitle = "Y= $/MMBTU (Gas) ; $/Mt (Coal)")+
  scale_color_manual(name="Region",values = c("green", "yellow", "blue","red"))
```













## Exercise 2 -- Interconnections


![some caption](./Material/interconnections.png) (SOURCE)





////////////////////////////////////Temp///////////////////////////////////


### Summary on data


**Task:** Just press *check*.
```{r "2__13"}
library(dplyr)
#TABLE 1 Summary Statistics
finaldata_allgens <- read_dta("Data/finaldata_allgens.dta")

table1 <- finaldata_allgens %>% 
  group_by(intercn) %>% 
  select(CO2MASS, load, gasprice2, coal_price) %>% 
  mutate(CO2MASS = CO2MASS/1000, load=load/1000, "Emission Rate"=CO2MASS/load, "Cost Ratio"=coal_price/gasprice2) %>% 
  rename("CO2 Emissions" = CO2MASS, Load=load, "Gas Price"=gasprice2, "Coal Price"=coal_price)   %>% 
  summarise_all("mean") 
  
#table1 <- table1 %>% 
 # rownames_to_column %>% 
  #gather(var, value, -rowname) %>% 
  #spread(rowname,value)


table1
```




## Exercise References


### Bibliography

- Cullen, Joseph A., and Erin T. Mansur. 2017. "Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach Using the Shale Revolution." American Economic Journal: Economic Policy, 9 (3): 106-33.

- Lafrancois, B. A. (2012), ‘A lot left over: Reducing CO2 emissions in the United States’ electric power sector through the use of natural gas’, Energy Policy 50, 428–435.


### R Packages

- Kranz, S. (2015): RTutor. "Creating R problem sets with automatic assessment of student's solutions", R package version 2019.10.11, https://github.com/skranz/RTutor

- Wickham, H. (2016): ggplot2. "Elegant Graphics for Data Analysis", Springer-Verlag, New York, R package version 3.2.1, http://CRAN.R-project.org/package=ggplot2

- Wickham, H., Francois, R., Henry, L., Muller, K., (2018): dplyr. "A Grammar of Data Manipulation", R package version 0.8.3, http://CRAN.R-project.org/package=dplyr

### Data Sources

- The World Bank , "Commodity Markets Monthly Prices",  https://www.worldbank.org/en/research/commodity-markets

monthly load data 


*All of the above links were accessable as of March 31, 2020.*




