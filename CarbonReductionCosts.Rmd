# Problem Set: Estimating CO2 Reduction Costs


```{r 'check_ps', include=FALSE}

user.name = '' # set to your user name

# To check your problem set, save your file (Ctrl-S) and then run the RStudio Addin 'Check Problemset'

# Alternatively run the following lines 
library(RTutor)
ps.dir = getwd() # directory of this file
ps.file = 'CarbonReductionCosts.Rmd' # name of this file
check.problem.set('CarbonReductionCosts', ps.dir, ps.file, user.name=user.name, reset=FALSE)
```


Author: Daniel Dreyer


<style>
img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
}
</style>

Welcome to this `Interactive Problem Set`. The world's energy demand are constantly increasing and at the same time so are carbon emission. High efforts are made to find technological improvement as well as find economic incentives to avoid long term effects of climate change through high emission. During this problem set, you will examine how carbon pricing would effect emissions in the U.S. electricity sector. 
The analysis is based on **"Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach using the Shale Revolution"** by Joseph A. Cullen, Erin T. Mansur (2016) - further referred as Cullen (2016). You can find the paper and further ressources here: <a href="https://www.aeaweb.org/articles?id=10.1257/pol.20150388   target = "_blank"> https://www.aeaweb.org/articles?id=10.1257/pol.20150388</a>

____ ergebnisse ____

We replicate the analysis proposed by Cullen (2016) with the help of the `Statstical Programming Language R`. I will explain important function along the way, but you are required to have basic knowledge of `Statistics` and `R`. If you are completely new to programming in `R` you should't feel left behind though. Understanding the basic concepts are pretty straight forward, you can find useful beginners guide [here](https://cran.r-project.org/manuals.html). Below you will find an overview of content and a guideline on how to deal with our interactive problems.  


### Contents


Text

$\qquad$  Overview
  
$\qquad$  1 TBA

$\qquad$  2 TBA

$\qquad$ $\qquad$ 2.1 

$\qquad$  3 TBA

$\qquad$  4 TBA

$\qquad$  5 Conclusion

$\qquad$ References


## Exercise Content


$\qquad$ *Exercise 1* - Motivation (rename later)

$\qquad$ *Exercise 2* - TBA

$\qquad$ *Exercise 3* - TBA

$\qquad$ *Exercise 4* - TBA

$\qquad$ *Exercise 5* - TBA


### ReadME


The problem set offers different ways of interaction. Some provide you additional information or test your knowledge, others need you to fill in small gaps of code. Coding exercises are marked as **TASK**. Below you can read find the different types of interactions with their corresponding functions:   

 - *Info Boxes*: Contain additional information on technical terms or documentation of functions.
 
 - *Quizzes*: Evaluate your knownledge of topics before we dive in our analysis.
 
 - *Code Chunks*: Require you to complete small parts of Code. The work flow of solving code chunks is intuitive and as followed:
                
  + `edit` : Click to start editing the Code chunk.
  + `run chunk`: Runs the chunk and displays outputs or errors in the corresponding console.
  + `check`: Check your input against the solution.
  + `hint` : You can request a hint if you have problem solving a task.  
&nbsp;

  
  Additional functions:    
                   
  + `data`: Redirects you to the data browser - you can navigate through the data set in an interface.
  + `solution` : Shows the solution of the task.  
&nbsp;


After finishing a exercise, click `Go to next exercise` at the bottom or navigate around with the help of the bar on top.


## Exercise 1 -- Insights into Energy Markets

Energy consumption of the world keeps rising daily. New technologies are being developed to produce `green` electricity, but we are still heavily dependant on `fossil fuels`. Coal is hereby one of the biggest and most important sources of energy, but at the same time the biggest cause of carbon emissions. It is easy to store, to transport, doesn't alter and can be mined in huge quantities all around the world. This makes it desirable and cheap to use as a reliable energy source. Given that coal supplies will last for centuries, it is a major goal to find incentitives to reduce its use and therefore emissions.
Another major energy ressource is `natural gas`. Even though still being a fossil fuel, its' emissions and heat density are way superior to coal. Nevertheless, natural gas wasn't considered to be an real alternative to coal because of higher costs through difficult extracting methods and handling.  
This changed due to the `Shale Revolution`, which started in the early 2000s in the United States. Natural gas began to not only be a by-product of the oil industry, but could now be extracted in large quantities and in a targeted manner. Lanfrancois (2012) estimates, that based on the `Clean Power Plan` introduced by the Obama Administration in 2015, carbon dioxide emissions from the electricity industry could be reduced by roughly 23 to 42 percent by replacing existing coal to gas fired generators.    
  
info("Shale-Revolution") # Run this line (Strg-Enter) to show info
  
Enough background for now, let's start with some interactive tasks. In `Exercise 1` we will get a feeling for the energy sector and explore time-series data of historic prices and generated power.

**Task:**
Use the `read_csv` command to *load the data set* and store it in a variable called `dat`. `Read_csv` displays the parsed type of each column after you execute the command. This will come handy later on in this exercise. In future exercises we will diable this message.

info("read.csv() and write.csv()") # Run this line (Strg-Enter) to show info

```{r "1__5"}
# ... <- read_csv("./Data/exercise1.csv")
```

**Task:** The first thing you should do after loading a new data set is looking at the structure. Use the `head()` command to show the first **eight** rows of the data set named `dat`.  

When not given a second argument, `head()` displays the first 5 rows on default. Alternatively, the problem set provides a seperate data tab. If you want to take a closer look at the data, especially later on in the problem set, you can click `data` and get redirected to the `Data Explorer` Tab, where you can navigate along the data frame and see some basic statistics.  

```{r "1__6"}
# head(dat, ...)
```

The data frame contains monthly numbers of generated MWh of coal and gas as well as prices of `natural gas` in Europe and the United States as well as the `natural gas index` from the year 2002 to the end of 2019. Keep in mind that different commodities are traded in different units. Coal in metric tons (`\$/mt`) and gas in British thermal units (`$/mmBTU`). The natural gas index is set to 100 in the year 2010 and changes accordingly. 
While reading in our current data set I mentioned that it would come handy to know which data types your columns inherit. `R` requires `dates` to be stored as type `Date`, otherwise we will get weird outputs when trying to plot along a time line. The date column is currently stored as type `character`. Therefore  we have to convert the date variable into a `date format` by using `as.Date()`.

**Task:**  Transform the data type with `as.Date()` and store the transformed variable to the same name.
```{r "1__7"}
# ... <- ...(dat$date, format="%m/%d/%Y")

```

Now that we imported our data set, got a first look on its structure and data, lets start creating our first plot. Basic `R` is the way to go if you want some quick visualisations. Additionally, `R` provides several packages to create highly customizable plots. In this problem set we will mostly use the package `ggplot2`. It is widely considered to be one of the most powerful packages to create plots, but having the downside that you have to get used to the handling. Because of that this proble mset doesn't require you to create whole plots on your own but requires you to fill in gaps. This way you will learn how the logic behind `ggplot2` works and at the same time won't be frustrated if the output doesn't meet the requirements.  
  
The first plot we create should tell us more about the development of gas prices along the time frame. As we have mentioned at the beginning of this exercise, the `Shale-Revolution` started in the beginning of this century. Therefore we expect falling gas prices for the U.S. market. Since commodity prices are split for regions/markets, the European Gas price should differ. Let's see if these assumptions are true.
  
**Task:** Use the data frame `dat` to plot historic prices of gas in Europe and the United States. Just press *check*.

info("ggplot2") # Run this line (Strg-Enter) to show info
```{r "1__8",fig.width=9, fig.height=6, dev='svg'}
ggplot(data=dat, aes(x=date)) +
  geom_line(aes(y=dat$price_naturalgas_USA, color="Gas US"), size=1) +
  geom_line(aes(y=dat$price_naturalgas_Europe, color="Gas Europe"), size=1) +
  labs(x = "Year", y = "", title = "Natural Gas Prices", subtitle = "Y=$/mmBTU")+
  scale_color_manual(name="Region",values = c("blue","red"))
```

Looking at the plot our assumptions are confirmed. The spikes in 2005 and 2008 are mostly consequences of the iraq war and the financial crisis. Apart from that, we observe a strict fall of gas prices in the U.S. from just over $12 in 2008 to under \$2 in 2016. Since ten the prices remained at roughly the same level. Natural gas prices in Europe have remained at a significantly higher level. One reason being is that fracking isn't as popular in Europe, therefore a major part of gas in Europe gets imported from Russia which drives prices. On the other hand Europe has a different energy mix. According to the European Environment Agency (EEA) the consumption of gas decreased in average by 1.4% per year since 2005, whereas in the U.S. natural gas reached new all-time highs nearly every year. Because of the lack of data provided by state officials in Europe, the analysis in this problem set will further purely focus on the U.S. market.

Before getting an insight into the generated power, take your first quiz:

#! addon__quiz__Proportion of Sectors
&nbsp;

**Task:** Create a new `ggplot2` for electricity generation. Plot the `date` on the x-Axisand the generated electricity on the y-Axis. We want seperate line for `gas generated power` as well as `coal generated power`. Lines are drawn with `geom_line`. For reference you can look at the code from the previous graph or conduct the `help()` function.

```{r "1__9",fig.width=9, fig.height=6, dev='svg'}
#ggplot(data=___, aes(x=___)) +
#  ____(aes(_=dat$generated_coal, color="Coal Generation (TWh)"), size=1, alpha=0.5) +
#  ____(aes(_=dat$generated_gas, color="Natural Gas Generation (TWh)"), size=1, alpha=0.5) +
#  labs(x = "Year", y = "", title = "Monthly Generation by Fueltype", subtitle = "Y=Monthly Electricty (TWh)")+
#  scale_color_manual(name="",values = c("black","red"))+
#  scale_y_continuous(breaks=seq(0,200,25))
ggplot(data=dat, aes(x=date)) +
  geom_line(aes(y=dat$generated_coal, color="Coal Generation (TWh)"), size=1, alpha=0.5) +
  geom_line(aes(y=dat$generated_gas, color="Natural Gas Generation (TWh)"), size=1, alpha=0.5) +
  labs(x = "Year", y = "", title = "Monthly Generation by Fueltype", subtitle = "Y=Monthly Electricty (TWh)")+
  scale_color_manual(name="",values = c("black","red"))+
  scale_y_continuous(breaks=seq(0,200,25))
```

The results are in line with what we should expect. With gas decreasing in price, gas plants increased their share in electricity production over time. Giving you a bit more background, coal-fired plants have lower operating costs than gas-fired generators, but are slow to adjust to fluctating demands and are expensive to start. Gas generators typically fill these gaps. There are two different types of gas-generators, one being `peaker plants`, which run in high demand hours due to their fast start-up times but high marginal costs. The other type being `combined cycle gas turbines` (CCGT), having low heat rates (high efficiency of turning fuel into power) and are used to provide baseline power generation throughout the day. Because of these factors we can assume that the two types of fuel generators are "switchable".  
However, the mechanism called `fuel switching` is a lot more complex than just about changing fuel prices. Factors like capacity of plants, transmission grid limits (Mansur & White 2012, Davis & Hausman 2015) or firms market power (Bushnell, Mansur & Saravia 2008) also play a role here. We try to include some but not all of them in our analysis later on.  
To wrap this up, we observe severe fluctuations, that occur yearly with a smaller peak in summer and a bigger in the winter season. The fluctuation are largely driven by Residential using air conditioning in summer and space heating in winter (EIA, "Today in Energy", 2020/3).  
  

In the next exercise we will go through necessary theory for our main analysis. Click `Go to next exercise` to continue.


## Exercise 2 -- Theory

### Relationship between Fuel and Carbon Prices

info("Variable names in this exercise") # Run this line (Strg-Enter) to show info

As seen in the last exercise there are more factors to `marginal costs` than just the commodity prices itself. With that in mind we define the `marginal costs` of fossil-powered plants as a Equation of `heat rate` and the `costs of burning fuel`. Variable names of this exercise are explained in the info-box above:

$$\tag{1}MC=HR\cdot(P_{fuel}+CO_{2,fuel}\cdot P_{co2})=HR\cdot C_{fuel}$$

In `Exercise 1` we observed generated electricity of `coal` and `gas` and their variance over time. Because of the fact that the cost efficiency of coal is generally better, we have to introduce a incentive to reduce the use of coal in relation to gas in electricity generation. One way to introdude a change in cost efficiency is to propose `carbon prices`. This is especially viable in this case because coal contains approximately `twice` as much $CO_2$ as natural gas and therefore stronger effects the cost efficiency. Another factor that drives this momentum is that gas generators generally have a more efficient heat rate than coal generators (as metioned at the end of last exercise).  
Combining these two facts of cost and generation efficiency lead to `steeper marginal cost` for coal generators when carbon prices are introduced. Reflecting this to our upcoming analysis, we don't observe any carbon prices, but a time-series of fuel prices that are transformed into burning costs with equation `(1)`. To implement the mechanism of `fuel change` we introduce a `coal-gas ratio`, which we define as followed:

$$\tag{2}costratio=\frac{C_{coal}}{C_{gas}}$$

Combining Equation `1` and `2`, we can explain `cost ratios` as a function of `fuel prices`, `carbon content` and `carbon prices`:

$$\tag{3}costratio=\frac{C_{coal}}{C_{gas}}=\frac{P_{coal}+CO_{2,coal}\cdot P_{co2}}{P_{gas}+CO_{2,gas}\cdot P_{co2}}$$

For completeness we introduce values for carbon content $CO_{2,coal}$ and  $P_{fuel}$, that will be fixed based on predictions for the year 2025. The `EIA` reports carbon content and forcasts for fuel prices. We will use these values later on in our analysis:  

- Average delivered coal price `$2.25/mmBTU` and gas prices `$5.75/mmBTU` (forcast for 2025)
- Carbon content `Natural Gas`: 117 lbs carbon/MMBTU or `0.0585 tons/MMBTU`  
- Carbon content `Coal`: 210.8 lbs carbon/MMBTU or `0.1054 tons/MMBTU`  

Lets quickly interpret `Equation 2`: The `price ratio` will rise for higher `costs of burning coal` or lower `costs of burning gas`. To make this even clearer, lets visualize the relationship, which replicates Figure 4 of Cullen.

<img src="./Material/relationship.png" alt="drawing" width="600"/>
Source: Cullen (2016)  
  
Panel `(a)` shows the relationship between fixed costs of `coal` and `gas` when `carbon prices` get introduced. As shown before we observe higher marginal costs for coal and at a certain value of carbon prices, gas becomes more cost efficient. Panel `(c)` shows the results when transforming fuel prices in price ratios as defined in `Equation 2`. We can observe the same in absence of carbon prices with fixed coal prices and variable gas prices as seen in panel `(b)` and `(d)`. 

#! addon__quiz__carbon prices
&nbsp;

The answer is the central idea to our analysis. We can create every variation of cost ratios, either by introducing `carbon prices` to fixed fuel prices, or without carbon prices by varying costs of `coal` and `gas`. We use this variation in the cost ratios observed in our data to understand how emissions change when gas generators become more competitive with coal plants (Cullen 2016). 

$$\tag{4}{P_{co2}}=\frac{costratio\cdot{P_{gas}}-{P_{coal}}}{CO_{2,coal}-costratio\cdot CO_{2,gas}}$$

We will use this equation in the second part of the analysis (`4.2`) to transform our fuel costs into carbon prices. Therefore we will be able to predict the impact of carbon taxes on emissions and calculate abatement costs.  
  
<br/><br/>
  
Since it is not common to have electricity grid in Europe that are formed like the ones in the United States, I will introduce the concept of interconnection in the following sub-section.

### Interconnections

<img src="./Material/interconnections.png" alt="drawing" width="600"/>
Source: Cullen (2016)

The American Electric system is made up of three major `interconnections`, which in turn concist of different balancing authorities (responsible for maintaining the electricity balance within the region). Local electricity grids are hereby connected to form a network, which provides higher stablity and reliability. These `interconnections` operate mostly independent from each other and exchange little to no electricity. This is a huge difference to the European electricity grid, where grid stability is ensured across borders.

In the graph below you can see the `3` interconnection we include data of in this problem set. I listed a few details for each below:
- `Eastern Interconnection`: Consists of 36 balancing authorities and extends from the East Coast to the Rocky Mountains.
- `Western Interconnection`: Involves 37 balancing authorities, which are located in the West of North America.
- `Electric Reliability Council of Texas` (ERCOT): Consists of large parts of Texas

You may ask yourself why we are even mentioning this. 


**Task:** Just press *check*.

info("geom_encircle") # Run this line (Strg-Enter) to show info

```{r "2"}
dat <- read_csv("Data/exercise3.csv")
ggplot(dat,aes(x=coalprice/gasprice,y=co2mass/1000,color=intercn))+
        geom_point(alpha=0.2) +
        geom_encircle(aes(group=intercn,fill=intercn),alpha=0.3, s_shape=1) +
        theme_bw()+ 
        labs(y="", 
        x="Price Ratio", 
        subtitle="y=CO2 Emissions in 1000 tons/day",
        title="Distribution of data")
```

TEXT




## Exercise 3.1 -- Emission Response Curves - A simple approach

A short recapture: Until now we got an idea how the energy market in the U.S. is build, how commodity prices changed over that and introduced the concept of `interconnections` . Additionally we
briefly went over the theory behind mapping carbon prices???. 
In `Chapter 3` we will present the needed regression theory and develop a model that will hopefully help us answer our main question on how carbon prices would effect emissions in the energy sector.
However we won't simpy propose a final model but will work our way from a simple linear regression model to more complex but also more accurate models. 



In this exercise we briefly go over the data we use for our main analysis and give an overview what we will be doing in the following exercises. The main question of this problem set is to find out
how carbon prices would effect emissions in the energy sector. To answer this we will construct a statistical model to understand the emission behaviour for changing input costs while controlling
for variables that effect the energy market. However we won't simply propose a final model but will work our way from simple linear regressions to more complex but also more accurate models.  
&nbsp;

Until now we got an idea how the energy market is 
In this and the following chapter we will take a look at regression theory and develop a model that satifies our statistical needs tor answer our initial question on how changing commodity prices will effect $CO_2$ emissions. We start with simple regressions and introduce new methods along the way to make our model more precise.

If you are purely interested in the final model and the economic impact, you can skip to `Exercise 4.1` onwards. This chapter will focus on regression theory which will allow us to construct a
fitting model and introduces some requirement to 

**Task:** To get started, load the data set `exercise3.csv`, press `edit` and `check` afterwards.

```{r "3_1",message=FALSE}
dat <- read_csv("Data/exercise3.csv")
head(dat,3)
```

In the last exercise we got a glimpse why it makes sense to calculate our model for each interconnection seperatly. We will get further indication on why that makes sense later on. For this purpose
we will filter our data set for interconnection `EAST` and develop the model based on these data. Once we found a fitting model we will use the model on each interconnection.    
To get started with our regression model, we will try to regress fuel prices against $CO_2$ emissions. As we have seen in the beginning of this problem set in `Exercise 1` we observe substantial
variation in coal and gas prices. While some of its' variation is regional, most of it comes from price variations over time. Because of that reason we construct a new variable called `Price Ratio`.
There are several ways to propose price ratios, we will use the ratio between the price of coal and gas and is defined as followed:  

$$\tag{2}priceratio=\frac{C_{coal}}{C_{gas}}$$

You may ask, why we won't simply use both fuel prices seperately, but construct the ratio. There are several benefits of doing so. Firstly, 



THe question here is, why use a priceratio and not just coal and gas prices seperatly.  ///////// why priceratio - paper 18 absatz 2


**Task:** The data set contains a column `intercn` with values `EAST`, `WEST` and `ERCOT`. Filter the data set for interconnection `EAST` and store the new data frame in variable `dat_east`. Additionally, calculate the cost ratio between `coalprice` and `gasprice` according to formula 2.

info("Pipe, mutate, select") # Run this line (Strg-Enter) to show info


```{r "3_1__3"}
# ... <- data %>% 
#  mutate(CR = .../...) %>% 
#  filter(intercn=="...")
```


### Stage 1: Linear Regression

We start by proposing a simple linear regression model. In a mathematical way we can express the relationship as followed:

$$\tag{3}CO_{2t}=\beta_{0}+\beta_{1}\cdot priceratio_{t}$$


info("Linear Regression with lm()") # Run this line (Strg-Enter) to show info

**Task:** Run a regression with `co2mass` as the dependent variable and `priceratio` as independent variable. Store it in the variable `fit1`. 
```{r "3_1__5"}
# ... <- lm(...~... , data=east)

```

#! addon__quiz__Reg1


TEXT

**Task:** To
```{r "3_1__6"}
summary(fit)
```

$\beta_{1}$

The summary statistics shows as a positive value for priceratio $\beta_{1}$, which means that a increasing price ratio decreases emissions.


For upcoming regressions we will use the `stargazer()` function from the `stargazer` package to show summary statistics from our regressions. We don't need get every information the basic functions displays, therefore we define a own custom function with statistics we need. Read below to find out more about `stargazer` and `custom functions` and continue with the next `task`.

info("Stargazer") # Run this line (Strg-Enter) to show info

info("Custom functions") # Run this line (Strg-Enter) to show info

**Task:** Click check to run the Code. It defines the function to show our custom regression tables.
```{r "3_1__9"}
show.regression= function(...){
  library(stargazer)
    stargazer(..., 
            type = "text", 
            style = "aer",  
            digits = 3,
            df = FALSE,
            report = "vct*",
            star.cutoffs = c(0.05, 0.01, 0.001),
            model.names = FALSE,
            object.names = TRUE,
            model.numbers = FALSE, 
            omit.stat=c("f", "ser")
    )
} 
show.regression(fit)
```

Our eventual goal is to plot the rensponse curves of changing ??AWD prices 

info("Predict") # Run this line (Strg-Enter) to show info

**Task:** To
```{r "3_1__10"}

```




**Task:** To
```{r "3_1__11"}

```




**Task:** Let's see what we just defined. Run the regression table for the linear model. Insert 
```{r "3_1__12"}
# regression.result(...)

```

TEXT

**Task:** To
```{r "3_1__13"}

```

QQ PLOT RESIDUALS?

info("R-squared") # Run this line (Strg-Enter) to show info

RMSE?

### Stage 2: Polynomial Regression

**Task:** Just press *check*.
```{r "3_1__14"}

```

**Task:** Just press *check*.
```{r "3_1__15"}

```

**Task:** Just press *check*.
```{r "3_1__16"}

```

**Task:** Just press *check*.
```{r "3_1__17"}

```

**Task:** Just press *check*.
```{r "3_1__18"}

```



## Exercise 3.2 -- Restricted Spline Regressions

### Stage 3: Cubic Spline





simple cubic splines

$$\tag{4}CO_{2t}=s(CR_{t}|\beta)$$

info("ns()") # Run this line (Strg-Enter) to show info

WIP





## Exercise 4 -- 

To this point we got an idea about the energy market in the U.S. and the theory needed to construct a model that will set carbon pricess in relation to carbon emissions. In this chapter we will 

Until now we worked with data sets that only include a portion of what we will use in our final model. Therefore we will use this exercise to present the data we use for our analysis and give an overview what we will be doing in the following exercises. 



answer this we will construct a statistical model to understand the emission behaviour for changing input costs while controlling
for variables that effect the energy market. However we won't simply propose a final model but will work our way from simple linear regressions to more complex but also more accurate models.  
&nbsp;

 - You can find a rough guideline of content in each exercise below:
  + `Exercise 4.1` - Estimated CO2 Response to Fuel Prices
  + `Exercise 4.2` - Imputed CO2 Response to Carbon Prices
&nbsp;
  
Before we head into our analysis we should make us familiar with the data we will be using. Up until now we constructed models with at most 2 dependent variables. In our final model we will add several control variables  
Before we take a look at the data, import our dataset.

**Task:** Load the data set `main_data.csv`, press `edit` and `check` afterwards.

```{r "4",message=FALSE}
dat <- read_csv("Data/main_data.csv")
head(dat,3)
```
&nbsp;

The data frame is a combination of data we used previous exercises and additional factors. It consists of `daily` information for `each interconnection` from 2006 to 2012. The meaning of each column is explained below:

`co2mass`: $CO_2$ emissions in tons  
`gasprice`: Capacity weighted average daily gas price per interconnetion ($ per million BTU)  
`coalprice`: Price of Coal ($ per million BTU)  
`load`: daily electricity consumption per interconnection in MWH  
`meant`: average daily temperature per interconnection  
`nonFossil`: Electricity generation with non-fossil fuel in MWH  
`so2price`: Permit prices of $SO_2$ ($/ton)  
`netNSflow`: MwH flowing from Canada to US by interconnection and month  

The data are gathered from several official U.S. agencies and aggregated to a daily level and seperated by interconnection. Because of the size of these data sets we wont do the data preparation in this problem set but rather provide the data sources. `Emission` data are measured by the Continuous Emissions Monitoring System (CEMS) of the `Environmental Protection Agency (EPA)`. The U.S. Energy Information Administration (EIA) collects data of `Non-fossil` energy production as well as spot prices of `coal prices` in Form 923. Spot prices of `gas` can be found in `Intercontinental Exchange (ICE)`. Data of `electricity consumption` or `load` are provided in Form 714 of the `Federal Energy Regulatory Commission (FERC)`, permit prices of $SO_2$ from the `EPA Clean Air Markets` and finally, `net imports` of electricity from Canada are gathered from the `National Energy Board of Canada`. Links to the sources can be found in the `References` section.

To give us an overview of the data, lets create a table with average values for relevant factors of each interconnection. `Dyplr` provides 


R provides several packages for that , but for now we work with packages we
introduced before and solve this with `dyplr`.  

**Task:** Use `group_by()` to group the dataset `dat` by `intercn`. Afterwards use `summarise_all()` to calculate the means of every column. You don't have to deal with the additional lines of code, which is used to create a more understandable output.

info("Group_by() and summarise()") # Run this line (Strg-Enter) to show info
  
info("kable()") # Run this line (Strg-Enter) to show info

///Tabelle mit einheiten

```{r "4__3"}
#... %>% 
#  select(intercn, co2mass, load, gasprice, coalprice) %>% 
#  group_by(...) %>% 
#  ...("mean") %>% 
#  mutate(co2mass = co2mass/1000, load=load/1000, "Emission Rate"=co2mass/load, "Cost Ratio"=coalprice/gasprice) %>% 
#  rename("CO2 Emissions"=co2mass, Load=load, "Gas Price"=gasprice, "Coal Price"=coalprice)
```

The table replicates `Table 1` from Cullen (2016) and reports the mean of several factors for each `interconnection`. We can clearly see that the East is by far the largest of the observed energy
markets. The emissions seem to increase proportionally to the electricity consumption if we take the electricity production from non-fossil sources in consideration. This gets clearer if the look at
the emission rates, which are defined as $ER=\frac{emissions}{load}$. Therefore the `Western` interconnection has by far the `cleanest` energy production, followed with some distance by Texas (`ERCOT`)
and the `Eastern` interconnection. Furthermore we observe clear variations in price ratios.  
This is in line with our assumptions from `Section 2`, where we stated that each interconnection has vastly different conditions and therefore should conduct our regression on each seperatly. In the next exercise we will use this data set and the regression theory we presented in `Chapter 3` to trace out the emission response curves.


Click `Go to next exercise` to continue.

## Exercise 4.1 -- Estimated CO2 Response to Fuel Prices

in this exercise we will combine the theory of `exercise 2` and regression theory of `chapter 3` to estimate the $CO_2$ response curves to changing fuel prices. To summarise what we got so far lets do a quick summary. In `exercise 2` we introduced the theory of mapping carbon prices to our cost ratios. In `exercise 3` we introduced the theory of cubic splines which we will use for our final model.
As a side note, the code isn't meant to be the shortest or the most efficient, but should allow you to follow each step we take to get our final results. Based on this we will explain and carry out the analysis step by step for interconnection `EAST`, afterwards apply it to `ERCOT` and `WECC` and interpret our results.

Building upon the model we defined in the last chapter, we will expand our regression model with several control variables as followed. The meaning and source of data to every variable is explained in the info box below:


We will perform a reduced-form regression which expands the cubic spline regression from exercise `3.2` and builds upon the theory of `exercise 2`. We define the model as followed:

$$\tag{5}CO_{2t}=s(priceratio_{t}|\beta)+s(load_{t}|\theta) + s(temp_t|\omega)+X_t\psi+D_\gamma+\epsilon_t$$

info("Model variables") # Run this line (Strg-Enter) to show info

The first step as in every exercise is loading our data set. 

**Task:** Load the dataframe and store it in `dat`. Create a new variable called `priceratio` and calculate the ratio $priceratio=\frac{C_{coal}}{C_{gas}}$. To save us another step, we will also create the seasonable dummy variable. 
```{r "4_1",message=FALSE}

```

**Task:** Filter the data set for intercn `EAST`.
```{r "4_1__2"}
#east <- filter(...,...)

```

**Task:** Calculate the `mean` of every variable we use in our regression. First, select the necessary columns and then use `summarise_all` to get the `mean`. Store the result in `mean_dat_east`.
```{r "4_1__3"}
# ... <- east %>% 
#  select(load, tlsd, tlmin, tlmax, meant, nonfossil, so2price, netNSflow, yearseason) %>% 
#  summarise_all(...)

```


**Task:** To make our life a bit easier we will create a new data set with `gasprice`, `priceratio` and the results of the `last` task. Use `tibble()`, which creates a new data frame and `cbind()`, which takes a sequence of columns and combines them with another data frame.

```{r "4_1__4"}
#temp_east <- ...(gasprice = east$gasprice, priceratio = east$priceratio) %>% 
#  ...(mean_east)
```

**Task:** Perform the regression model we described in the beginning of this exercise for interconnection `EAST`. Use `ns()` for variables with spline regression (as explained in `3.3`). We want to use `5` degrees of freedom. Store the resulting model in `reg_east`.
```{r "4_1__5"}
#... <- lm(co2mass ~ ...(priceratio, df=...) + ...(load, df=...) + tlsd + tlmin + tlmax + ...(meant, df=...) + nonfossil + so2price + netNSflow + yearseason, data=east)

```

**Task:** Predict $CO_2$ emissions based on the regression model `reg_east` and `temp_east`. We set interval to `confidence` to get the mean interval and be able to plot a confidence band later on.
Just press *check*.

info("Confidence interval") # Run this line (Strg-Enter) to show info

```{r "4_1__6"}
fit_east <- predict_east %>% 
  cbind(as.data.frame(predict(reg_east, newdata = predict_east, interval = 'confidence')))
```

**Task:** Just press *check*.
```{r "4_1__7"}

```

**Task:** Just press *check*.
```{r "4_1__8",warning=FALSE, fig.width=7, fig.height=7}
plot_east <- ggplot(final_east, aes(x=basecoal/priceratio, y=fit.transformed)) +
  geom_ribbon(aes_string(ymin = final_east$lwr.transformed, ymax = final_east$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5,) +
  geom_line(aes(y=fit.transformed)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.15,.05)) +
  geom_vline(xintercept = 5.75, linetype = "dashed") + 
  scale_x_continuous(breaks=c(2,3,4,5,6,7,8,9,10,11,12), limits=c(2.2, 12)) +
  labs(title="Eastern Interconnection", subtitle = "y=Percentage Change in CO2 emissions",
       y="", x="Gas Price $/MMBTU") +
  theme_minimal()

plot_east
```

TEXT////



**Task:** Run the code for the `ERCOT` interconnection. Just press *check*.
```{r "4_1__9",warning=FALSE, fig.width=7, fig.height=7}
ercot <- filter(dat, intercn=="ERCOT")

mean_ercot <- ercot %>% 
  select(load, tlsd, tlmin, tlmax, meant, nonfossil, so2price, netNSflow, yearseason) %>% 
  summarise_all(mean)

predict_ercot <- tibble(date=ercot$date, intercn=ercot$intercn, gasprice = ercot$gasprice, coalprice=ercot$coalprice, priceratio = ercot$priceratio) %>% cbind(mean_ercot)

reg_ercot <- lm(co2mass ~ ns(priceratio, df=5) + ns(load, df=5) + tlsd + tlmin + tlmax + ns(meant, df=5) + nonfossil + so2price + netNSflow + yearseason, data=ercot)

#ERCOT has no net imports of electricity, predict throws warning
fit_ercot <- predict_ercot %>% 
  cbind(as.data.frame(predict(reg_ercot, newdata = predict_ercot, interval = 'confidence')))

diff_base <- abs(ercot$priceratio - (basecoal/basegas))
min_dif <- min(diff_base)
closest <- min_dif==diff_base
base_emit <- mean(fit_ercot$fit[which(closest)])

final_ercot <- fit_ercot %>% 
  mutate(fit.transformed=fit/base_emit-1,
         lwr.transformed=lwr/base_emit-1,
         upr.transformed=upr/base_emit-1)


plot_ercot <- ggplot(final_ercot, aes(x=basecoal/priceratio, y=fit.transformed)) +
  geom_ribbon(aes_string(ymin = final_ercot$lwr.transformed, ymax = final_ercot$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5) +
  geom_line(aes(y=fit.transformed)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.15,.05)) +
  geom_vline(xintercept = 5.75, linetype = "dashed") + 
  scale_x_continuous(breaks=c(2,3,4,5,6,7,8,9,10,11,12), limits=c(2.2, 12)) +
  labs(title="ERCOT Interconnection", subtitle = "y=Percentage Change in CO2 emissions",
       y="", x="Gas Price $/MMBTU") +
  theme_minimal()
```

**Task:** Run the code for the `WECC` interconnection. Just press *check*.
```{r "4_1__10",warning=FALSE, fig.width=7, fig.height=7}
wecc <- filter(dat, intercn=="WECC")

mean_wecc <- wecc %>% 
  select(load, tlsd, tlmin, tlmax, meant, nonfossil, so2price, netNSflow, yearseason) %>% 
  summarise_all(mean)

predict_wecc <- tibble(date=wecc$date, intercn=wecc$intercn, gasprice = wecc$gasprice, coalprice=wecc$coalprice, priceratio = wecc$priceratio) %>% cbind(mean_wecc)

reg_wecc <- lm(co2mass ~ ns(priceratio, df=5) + ns(load, df=5) + tlsd + tlmin + tlmax + ns(meant, df=5) + nonfossil + so2price + netNSflow + yearseason, data=wecc)

fit_wecc <- predict_wecc %>% 
  cbind(as.data.frame(predict(reg_wecc, newdata = predict_wecc, interval = 'confidence')))

base_emit <- mean(fit_wecc$fit[which(min(abs(wecc$priceratio - (basecoal/basegas)))==abs(wecc$priceratio - (basecoal/basegas)))])

final_wecc <- fit_wecc %>% 
  mutate(fit.transformed=fit/base_emit-1,
         lwr.transformed=lwr/base_emit-1,
         upr.transformed=upr/base_emit-1)

plot_wecc <- ggplot(final_wecc, aes(x=basecoal/priceratio, y=fit.transformed)) +
  geom_ribbon(aes_string(ymin = final_wecc$lwr.transformed, ymax = final_wecc$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5) +
  geom_line(aes(y=fit.transformed)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.15,.05)) +
  geom_vline(xintercept = 5.75, linetype = "dashed") + 
  scale_x_continuous(breaks=c(2,3,4,5,6,7,8,9,10,11,12), limits=c(2.2, 12)) +
  labs(title="Western Interconnection", subtitle = "y=Percentage Change in CO2 emissions",
       y="", x="Gas Price $/MMBTU") +
  theme_minimal()
```

**Task:** Use grid.arrange() to display the plots next to each other. Just press *check*.

```{r "4_1__11",warning=FALSE, fig.width=14, fig.height=7}
```


//TEXT, east oben, hier verlgeich zu ercot, wecc






///////// test
```{r "4_1__12"}

```





In the next exercise we will map the emission response curves from this exercise into carbon prices and estimate the effects of carbon prices on emissions as well as the associated costs. Click `Go to next exercise` to continue.


## Exercise 4.2 --  Imputed CO2 Response to Carbon Prices

During exercise `4.1`, we have seen that $CO_2$ emissions could be greatly reduced when changing fuel prices of `coal` and `gas`. We already introduced the theory behind mapping carbon in prices in exercise `2`. In this exercise we will follow the analysis of Cullen (2016) and transform the priceratio of the two commodities into `carbon prices`. This will allow us to estimate the change in emission with certain carbon taxes and approximate costs of these emission reductions. We split this exercise in two logical parts, first we will transform the results we gathered in exercise `4.1` with the help of `Equation 3`. Afterwards we will plot the emission response curves on carbon taxes.

For reference or when you decided to skip to this exercise I once again include the equation. Additionally we will use the same values for baseline fuel prices and carbon content as introduced in `exercise 2` and used in `exercise 4.1`.

$$\tag{3}{P_{co2}}=\frac{CR\cdot{P_{gas}}-{P_{coal}}}{CO_{2,coal}-CR\cdot CO_{2,gas}}$$

- Average delivered coal price `$2.25/mmBTU` and gas prices `$5.75/mmBTU` for 2025. 
- Carbon content `Natural Gas`: 117 lbs carbon/MMBTU or `0.0585 tons/MMBTU`
- Carbon content `Coal`: 210.8 lbs carbon/MMBTU or `0.1054 tons/MMBTU` (averaged on weighted fuel consumption according to EIA Form 923)


As mentioned the goal of this exercise is to transform the response curves of exercise `4.1` into emission abatement curves. To avoid repeating the same steps as before, I prepared a data frame that includes the predicted `emissions` as well as the `tranformed emissions` with confidence intervals. Load the data set `main_data2.csv` and store it in `dat`. `Head()` will show you the first rows. To save us some time, we also declare the fixed values as described above.

**Task:** Just press *check*.
```{r "4_2",message=FALSE}
dat <- read_csv("Data/main_data2.csv")
head(dat,3)

basegas <- 5.75
basecoal <- 2.25
gas_cc <- 0.0585
coal_cc <- 0.1054
```

As we have all needed data now, we can calculate the carbon taxes in the next step. We will get negative tax values because of our method, therefore we will filter them out. It would't make much
sense for us here to consider negative taxes.

**Task:** Create a column `carbontax` using `Equation 3` and filter the just calculated taxes for the interval [0,80]. Save the result into data frame `tax` and display the first rows.
```{r "4_2__2",message=FALSE}
#... <- dat %>% 
#  mutate(carbontax = (priceratio*...-...)/(coal_cc-priceratio*gas_cc)) %>% 
#  filter(carbontax >= ... & carbontax <= ...)
#
#head(...,...)

```

The overall approach is similar to the one in exercise `4.1`. We will filter for each interconnection seperatly and plot our result with `ggplot2`. First we will create a plot for interconnection
`EAST` and interpret the results. Afterwards we will run the code on the other interconnections and compare them to another. In contrast to exercise `4.1` though, we won't plot the emission change,
but the abated $CO_2$ emissions.

**Task:** Filter the data frame `tax` for interconnection `EAST` and save it to `tax_east`. Since we filter for a string, don't forget to put quotes around the argument.
```{r "4_2__3"}
#

```

**Task:** Just press *check*.
```{r "4_2__4",fig.width=7, fig.height=7}
plot_east <- ggplot(tax_east, aes(x=carbontax, y=-fit.transformed)) +
  geom_ribbon(aes_string(ymin = -tax_east$lwr.transformed, ymax = -tax_east$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5) +
  geom_line(aes(y=-fit.transformed)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.01,0.15)) +
  scale_x_continuous(limits=c(0, 80)) +
  labs(title="Eastern Interconnection",
       y="CO2 Emissions abated as a Percentage of Baseline Emissions", x="", subtitle="y=Carbon Price $/ton")  +
  coord_flip()

plot_east
```

///////TEXT

**Task:** Run the code for the `ERCOT` interconnection. Just press *check*.
```{r "4_2__5",fig.width=7, fig.height=7}
tax_ercot <- filter(tax, intercn=="ERCOT")

plot_ercot <- ggplot(tax_ercot, aes(x=carbontax, y=-fit.transformed)) +
  geom_ribbon(aes_string(ymin = -tax_ercot$lwr.transformed, ymax = -tax_ercot$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5) +
  geom_line(aes(y=-fit.transformed)) +  
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.01,0.15)) +
  scale_x_continuous(limits=c(0, 80)) +
  labs(title="Ercot Interconnection",
       y="CO2 Emissions abated as a Percentage of Baseline Emissions", x="", subtitle="y=Carbon Price $/ton") + 
  coord_flip()
```

**Task:** Run the code for the `WECC` interconnection. Just press *check*.
```{r "4_2__6",fig.width=7, fig.height=7}
tax_wecc <- filter(tax, intercn=="WECC")

plot_wecc <- ggplot(tax_wecc, aes(x=carbontax, y=-fit.transformed)) +
  geom_ribbon(aes_string(ymin = -tax_wecc$lwr.transformed, ymax = -tax_wecc$upr.transformed),
                   colour="lightgrey", fill="lightgrey", alpha=0.5) +
  geom_line(aes(y=-fit.transformed)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits=c(-.01,0.15)) +
  scale_x_continuous(limits=c(0, 80)) +
  labs(title="Western Interconnection",
       y="CO2 Emissions abated as a Percentage of Baseline Emissions", x="", subtitle="y=Carbon Price $/ton") + 
  coord_flip()
```
&nbsp;
#! addon__quiz__Compare emission abatement

&nbsp;  
  
**Task:** Just press *check*.
```{r "4_2__7",fig.width=21, fig.height=7}

```

TEXT



**Task:** Just press *check*.
```{r "4_2__8"}
find_closest_value <- function(a) {
  vector <- 1:9
  for(i in 0:8){
   vector[i+1] = mean(a$fit[which.min(abs(a$carbontax - i*10))])
  }
  return(vector)
}
temp1 = data.frame(tax=seq(0,80,10),east_emission=round(find_closest_value(tax_east)/100000,1), ercot_emission=round(find_closest_value(tax_ercot)/100000,1), wecc_emission=round(find_closest_value(tax_wecc)/100000,1))

temp2 <- temp1 %>% 
  mutate(perc_east=round((1-temp1$east_emission/temp1$east_emission[1])*100,1),
         perc_ercot=round((1-temp1$ercot_emission/temp1$ercot_emission[1])*100,1),
         perc_wecc=round((1-temp1$wecc_emission/temp1$wecc_emission[1])*100,1),
         emission_all=east_emission+ercot_emission+wecc_emission)

temp3 <- temp2 %>% 
  mutate(perc_all=round((1-temp2$emission_all/temp2$emission[1])*100,1))
  
table <- temp3 %>%
  select(c(1,2,5,3,6,4,7,8,9)) %>%
  kable(format="html", col.names = c("Tax","abs.","%","abs.","%","abs.","%","abs.","%"), align="c", caption = "Precited Emissions and Percentage Abatement") %>%
  add_header_above(c(" "=1, "East" = 2, "ERCOT" = 2, "West" = 2, "Total" = 2)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = F)%>%
  #column_spec(1:9, width = "0.4") %>%
  footnote(general = "Predicted emission are in 100.000 tons/day. Change to baseline (Tax=0).")

table
```


The result corresponds to Table 2 in Cullen(2016). 

TEXT





```{r "4_2__9"}
```
















To conclude our analysis we can calculate the abatement costs for certain carbon taxes. Lets say we introduce a carbon tax of `40$/ton`


Calculating costs






Concluding, our results seem to be robust  to parameter changes.

## Exercise 5 -- Conclusion


```{r "5"}
awards()
```


The methods used here can be further used to generate additoinal results. This could be a point where you can go on.




## Exercise 6 -- Bonus - Robutness Tests

//// einschub robustness test mit anderen definition von priceratios , appendix a2< number of knots NUR FUER EAST, danach kurz interpretieren

#! start_note "Robustness Test - andere priceratio"

```{r "6",optional=TRUE}
# show that all integers between 0 and 10
```

#! end_note

#! start_note "Robustness Test - weniger knots"

```{r "6__2",optional=TRUE}
# show that all integers between 0 and 10
```

#! end_note



## Exercise References


### Bibliography

- Cullen, Joseph A., and Erin T. Mansur. 2017. "Inferring Carbon Abatement Costs in Electricity Markets: A Revealed Preference Approach Using the Shale Revolution." American Economic Journal: Economic Policy, 9 (3): 106-33.

- Lafrancois, B. A. (2012), ‘A lot left over: Reducing CO2 emissions in the United States’ electric power sector through the use of natural gas’, Energy Policy 50, 428–435.


/add literature, exercise 2

### R Packages

- Auguie, B. (2017): gridExtra: "Functions in Grid graphics", R package version 2.3, http://cran.r-project.org/web/packages/gridExtra/index.html

- Hlavac, Marek (2018). stargazer: Well-Formatted Regression and Summary Statistics Tables. R package version 5.2.2. https://CRAN.R-project.org/package=stargazer 

- Kranz, S. (2015): RTutor. "Creating R problem sets with automatic assessment of student's solutions", R package version 2019.10.11, https://github.com/skranz/RTutor

- Rudis, B. (2017): ggalt: "Extra Coordinate Systems, 'Geoms', Statistical Transformations, Scales and Fonts for 'ggplot2'", R package version 0.4.0, https://cran.r-project.org/web/packages/ggalt/index.html

- Wickham, H. (2016): ggplot2. "Elegant Graphics for Data Analysis", Springer-Verlag, New York, R package version 3.2.1, http://CRAN.R-project.org/package=ggplot2

- Wickham, H., Francois, R., Henry, L., Muller, K., (2018): dplyr. "A Grammar of Data Manipulation", R package version 0.8.3, http://CRAN.R-project.org/package=dplyr

- Zhu, H. (2019), kableExtra: "Construct Complex Table with 'kable' and Pipe Syntax", R package version 1.1.0, https://cran.r-project.org/web/packages/kableExtra/index.html

/// add packages, "splines", "regtools", "ggalt?" ,"kable"
 
### Data Sources

- European Environment Agency, "Primary Energy Consumption by Fuel", https://www.eea.europa.eu/data-and-maps/indicators/primary-energy-consumption-by-fuel-6/assessment-2

- Federal Energy Regulatory Comission, "Form  No. 714 Annual Electric Balancing Authority Area
and Planning Area Report", https://www.ferc.gov/docs-filing/forms/form-714/data.asp

- Government of Canada, "Canada Energy Regulator", https://www.cer-rec.gc.ca/bts/ctrg/gnnb/lctrctxprts/index-eng.html

- Intercontinental Exchange, "Commodity Prices", https://www.theice.com/marketdata/reports

- National Centers for environmental Information (NOAA), Climate data, https://www.ncdc.noaa.gov/cag/statewide/time-series

- The World Bank , "Commodity Markets Monthly Prices",  https://www.worldbank.org/en/research/commodity-markets

- United States Environmental Protection Agency, "SO2 Trading Program", https://ampd.epa.gov/ampd/

- U.S. Energy Information Administration, "FAQ", (https://www.eia.gov/tools/faqs/faq.php?id=73&t=11)

- U.S. Energy Information Administration, "Form EIA-923", https://www.eia.gov/electricity/data/eia923/

- U.S. Energy Information Administration, "Today in Energy", https://www.eia.gov/todayinenergy/detail.php?id=43035

*All of the above links were accessable as of March 31, 2020.*

